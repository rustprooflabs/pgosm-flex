<!DOCTYPE HTML>
<html lang="en" class="rust" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PgOSM Flex User Guide</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="PgOSM Flex provides high quality OpenStreetMap datasets in PostGIS using the osm2pgsql Flex output">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('rust')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">About PgOSM Flex</a></li><li class="chapter-item expanded affix "><a href="code-of-conduct.html">Code of Conduct</a></li><li class="chapter-item expanded affix "><a href="contributing.html">Contributing to PgOSM Flex</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="quick-start.html"><strong aria-hidden="true">1.</strong> Quick Start</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="windows.html"><strong aria-hidden="true">1.1.</strong> Running on Windows</a></li></ol></li><li class="chapter-item expanded "><a href="customizations.html"><strong aria-hidden="true">2.</strong> Customize PgOSM Flex</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="common-customization.html"><strong aria-hidden="true">2.1.</strong> Common Customizations</a></li><li class="chapter-item expanded "><a href="layersets.html"><strong aria-hidden="true">2.2.</strong> Layersets</a></li><li class="chapter-item expanded "><a href="custom-indexes.html"><strong aria-hidden="true">2.3.</strong> Indexes</a></li><li class="chapter-item expanded "><a href="configure-postgres.html"><strong aria-hidden="true">2.4.</strong> Configure Postgres</a></li><li class="chapter-item expanded "><a href="data-files.html"><strong aria-hidden="true">2.5.</strong> Data Files</a></li></ol></li><li class="chapter-item expanded "><a href="query.html"><strong aria-hidden="true">3.</strong> Query examples</a></li><li class="chapter-item expanded "><a href="routing.html"><strong aria-hidden="true">4.</strong> Routing</a></li><li class="chapter-item expanded "><a href="performance.html"><strong aria-hidden="true">5.</strong> Processing Time</a></li><li class="chapter-item expanded affix "><li class="part-title">Production usages</li><li class="chapter-item expanded "><a href="postgres-permissions.html"><strong aria-hidden="true">6.</strong> Postgres Permissions</a></li><li class="chapter-item expanded "><a href="postgres-external.html"><strong aria-hidden="true">7.</strong> Using External Postgres Connection</a></li><li class="chapter-item expanded "><a href="data-updates.html"><strong aria-hidden="true">8.</strong> Data updates</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="replication.html"><strong aria-hidden="true">8.1.</strong> Using Replication</a></li><li class="chapter-item expanded "><a href="relocate-data.html"><strong aria-hidden="true">8.2.</strong> Relocate Data</a></li><li class="chapter-item expanded "><a href="update-mode.html"><strong aria-hidden="true">8.3.</strong> Using Update Mode</a></li></ol></li><li class="chapter-item expanded "><a href="qgis-styles.html"><strong aria-hidden="true">9.</strong> QGIS Styles</a></li><li class="chapter-item expanded affix "><li class="part-title">Developers</li><li class="chapter-item expanded "><a href="force-load.html"><strong aria-hidden="true">10.</strong> Force Load</a></li><li class="chapter-item expanded "><a href="projects.html"><strong aria-hidden="true">11.</strong> Projects using PgOSM Flex</a></li><li class="chapter-item expanded "><a href="docker-build.html"><strong aria-hidden="true">12.</strong> Build and Push Docker Images</a></li><li class="chapter-item expanded "><a href="tests.html"><strong aria-hidden="true">13.</strong> Testing PgOSM Flex</a></li><li class="chapter-item expanded "><a href="qgis-styles-dev.html"><strong aria-hidden="true">14.</strong> Developing QGIS Styles</a></li><li class="chapter-item expanded "><a href="troubleshooting.html"><strong aria-hidden="true">15.</strong> Troubleshoot errors in osm2pgsql processing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">PgOSM Flex User Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rustprooflabs/pgosm-flex" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="pgosm-flex"><a class="header" href="#pgosm-flex">PgOSM Flex</a></h1>
<p>PgOSM Flex (<a href="https://github.com/rustprooflabs/pgosm-flex">GitHub</a>)
provides high quality OpenStreetMap datasets in PostGIS using the
<a href="https://osm2pgsql.org/doc/manual.html#the-flex-output">osm2pgsql Flex output</a>.
This project provides a curated set of Lua and SQL scripts to clean and organize
the most commonly used OpenStreetMap data, such as roads, buildings, and points of interest (POIs).</p>
<p>Running PgOSM Flex is easy via the PgOSM Docker image
<a href="https://hub.docker.com/repository/docker/rustprooflabs/pgosm-flex">hosted on Docker Hub</a>.</p>
<ol>
<li>The <a href="quick-start.html">quick start</a> shows how easy it is to get started</li>
<li>Change how PgOSM Flex runs with <a href="common-customization.html">common customizations</a></li>
<li><a href="layersets.html">Customize layersets</a> to change what data you load</li>
<li>Configure <a href="postgres-external.html">connection to external</a> database, and use <a href="replication.html">replication</a></li>
</ol>
<h2 id="project-goals"><a class="header" href="#project-goals">Project goals</a></h2>
<ul>
<li>High quality spatial data</li>
<li>Reliable</li>
<li>Easy to customize</li>
<li>Easy to use</li>
</ul>
<h2 id="project-decisions"><a class="header" href="#project-decisions">Project decisions</a></h2>
<p>A few decisions made in this project:</p>
<ul>
<li>ID column is <code>osm_id</code> and is always <code>PRIMARY KEY</code></li>
<li>Geometry column named <code>geom</code></li>
<li>Defaults to same units as OpenStreetMap (e.g. km/hr, meters)</li>
<li>Data not included in a dedicated column is available from <code>osm.tags.tags</code> (<code>JSONB</code>)</li>
<li>Points, Lines, and Polygons are not mixed in a single table</li>
<li>Tracks latest Postgres, PostGIS, and osm2pgsql versions</li>
</ul>
<p>This project's approach is to do as much processing in the Lua styles
passed along to osm2pgsql, with post-processing steps creating indexes,
constraints and comments.</p>
<h2 id="versions-supported"><a class="header" href="#versions-supported">Versions Supported</a></h2>
<p>Minimum versions supported:</p>
<ul>
<li>Postgres 12</li>
<li>PostGIS 3.0</li>
</ul>
<p>This project will attempt, but not guarantee, to support PostgreSQL 12 until it
reaches it EOL support.</p>
<p>The Docker image is pinned to osm2pgsql's <code>master</code> branch. Users of the Docker image
naturally use the latest version of osm2pgsql at the time the Docker image was created.</p>
<p>This project runs entirely in Docker, optionally connecting to an external Postgres instance.
It should work on any typical OS able to run Docker.</p>
<h2 id="minimum-hardware"><a class="header" href="#minimum-hardware">Minimum Hardware</a></h2>
<h3 id="ram"><a class="header" href="#ram">RAM</a></h3>
<p>osm2pgsql requires <a href="https://osm2pgsql.org/doc/manual.html#main-memory">at least 2 GB RAM</a>.</p>
<h3 id="storage"><a class="header" href="#storage">Storage</a></h3>
<p>Fast SSD drives are strongly recommended.  It should work on slower storage devices (HDD,
SD, etc),
however the <a href="https://github.com/rustprooflabs/osm2pgsql-tuner">osm2pgsql-tuner</a>
package used to determine the best osm2pgsql command assumes fast SSDs.</p>
<h2 id="rustproof-labs-project"><a class="header" href="#rustproof-labs-project">RustProof Labs project</a></h2>
<p>PgOSM Flex is a RustProof Labs project developed and maintained by Ryan Lambert.
See the <a href="https://blog.rustprooflabs.com/category/pgosm-flex">RustProof Labs blog</a>
for more resources and examples of using PgOSM Flex.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pgosm-flex-community-code-of-conduct"><a class="header" href="#pgosm-flex-community-code-of-conduct">PgOSM Flex Community Code of Conduct</a></h1>
<h2 id="why-have-a-code-of-conduct"><a class="header" href="#why-have-a-code-of-conduct">Why have a Code of Conduct?</a></h2>
<p>Online communities include people from many different backgrounds. The PgOSM Flex contributors are committed to providing a friendly, safe and welcoming environment for all, regardless of age, disability, gender, nationality, ethnicity, religion, sexuality, or similar personal characteristic.</p>
<p>The first goal of the Code of Conduct is to specify a baseline standard of behavior so that people with different social values and communication styles can talk about PgOSM Flex effectively, productively, and respectfully.</p>
<p>The second goal is to provide a mechanism for resolving conflicts in the community when they arise.</p>
<p>The third goal of the Code of Conduct is to make our community welcoming to people from different backgrounds. Diversity is critical to the project; for PgOSM Flex to be successful, it needs contributors and users from all backgrounds.</p>
<p>With that said, a healthy community must allow for disagreement and debate. The Code of Conduct is not a mechanism for people to silence others with whom they disagree.</p>
<h2 id="where-does-the-code-of-conduct-apply"><a class="header" href="#where-does-the-code-of-conduct-apply">Where does the Code of Conduct apply?</a></h2>
<p>If you participate in or contribute to the PgOSM Flex ecosystem in any way, you are encouraged to follow the Code of Conduct while doing so.</p>
<p>Explicit enforcement of the Code of Conduct applies to the PgOSM Flex GitHub project and code reviews.</p>
<h2 id="values"><a class="header" href="#values">Values</a></h2>
<p>These are the values to which people in the PgOSM Flex should aspire.</p>
<ul>
<li>Be friendly and welcoming</li>
<li>Be patient
<ul>
<li>Remember that people have varying communication styles and that not everyone is using their native language. (Meaning and tone can be lost in translation.)</li>
</ul>
</li>
<li>Be thoughtful
<ul>
<li>Productive communication requires effort. Think about how your words will be interpreted.</li>
<li>Remember that sometimes it is best to refrain entirely from commenting.</li>
</ul>
</li>
<li>Be respectful
<ul>
<li>In particular, respect differences of opinion.</li>
</ul>
</li>
<li>Be charitable
<ul>
<li>Interpret the arguments of others in good faith, do not seek to disagree.</li>
<li>When we do disagree, try to understand why.</li>
</ul>
</li>
<li>Avoid destructive behavior:
<ul>
<li>Derailing: stay on topic; if you want to talk about something else, start a new conversation.</li>
<li>Unconstructive criticism: don't merely decry the current state of affairs; offer—or at least solicit—suggestions as to how things may be improved.</li>
<li>Snarking (pithy, unproductive, sniping comments)</li>
<li>Discussing potentially offensive or sensitive issues unless directly technically relevant; this all too often leads to unnecessary conflict.</li>
<li>Microaggressions: brief and commonplace verbal, behavioral and environmental indignities that communicate hostile, derogatory or negative slights and insults to a person or group.</li>
</ul>
</li>
</ul>
<p>People are complicated. You should expect to be misunderstood and to misunderstand others; when this inevitably occurs, resist the urge to be defensive or assign blame. Try not to take offense where no offense was intended. Give people the benefit of the doubt. Even if the intent was to provoke, do not rise to it. It is the responsibility of <em>all parties</em> to de-escalate conflict when it arises.</p>
<h2 id="unwelcome-behavior"><a class="header" href="#unwelcome-behavior">Unwelcome behavior</a></h2>
<p>These actions are explicitly forbidden in PgOSM Flex spaces:</p>
<ul>
<li>Insulting, demeaning, hateful, or threatening remarks.</li>
<li>Discrimination based on age, disability, gender, nationality, ethnicity, religion, sexuality, or similar personal characteristic.</li>
<li>Bullying or systematic harassment.</li>
<li>Revealing private information about other participants without explicit permission ("doxxing").</li>
<li>Unwelcome sexual advances.</li>
<li>Incitement to any of these.</li>
</ul>
<h2 id="moderation"><a class="header" href="#moderation">Moderation</a></h2>
<p>The PgOSM Flex spaces are not free speech venues; they are for discussion about PgOSM Flex.</p>
<p>When using the PgOSM Flex spaces you should act in the spirit of the values. If you conduct yourself in a way that is explicitly forbidden by the CoC, you will be warned and asked to stop. If you do not stop, you will be removed from our community spaces temporarily. Repeated, willful breaches of the CoC will result in a permanent ban.</p>
<h2 id="reporting-issues"><a class="header" href="#reporting-issues">Reporting issues</a></h2>
<p>The PgOSM Flex maintainers are responsible for handling conduct-related issues. Their goal is to de-escalate conflicts and try to resolve issues to the satisfaction of all parties.</p>
<p>If you encounter a conduct-related issue, you should report it to the maintainers by sending them <a href="mailto:support@rustprooflabs.com">an email</a>. In the event that you wish to make a complaint against a maintainer, you may instead contact the other maintainers.</p>
<p><strong>Note that the goal of the Code of Conduct and the maintainers is to resolve conflicts in the most harmonious way possible.</strong> We hope that in most cases issues may be resolved through polite discussion and mutual agreement. Bans and other forceful measures are to be employed only as a last resort.</p>
<p>Changes to the Code of Conduct should be proposed as pull requests.</p>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<ul>
<li>Treat everyone with respect and kindness.</li>
<li>Be thoughtful in how you communicate.</li>
<li>Don’t be destructive or inflammatory.</li>
<li>If you encounter an issue, please mail the maintainers.</li>
</ul>
<h2 id="acknowledgements"><a class="header" href="#acknowledgements">Acknowledgements</a></h2>
<p>This document is based on the <a href="https://github.com/gravitystorm/openstreetmap-carto/blob/master/CODE_OF_CONDUCT.md">OpenStreetMap Carto Code of Conduct</a>, which in turn has parts derived from the Code of Conduct documents of the Go Community, Django, FreeBSD, and Rust projects.</p>
<p>This document is licensed under the Creative Commons Attribution 3.0 License.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing"><a class="header" href="#contributing">Contributing</a></h1>
<p>Thank you for your interest in contributing to PgOSM Flex!</p>
<p>All types of contributions are encouraged and valued. This page outlines
different ways you can contribute with details about how this project handles them.
Please make sure to read the relevant sections below before making your contribution.
This makes it much easier for maintainers and smooths out the experience for
everyone involved.</p>
<p>The PgOSM Flex community looks forward to your contributions. 🎉</p>
<blockquote>
<p>If you like the project, but do not have time to contribute directly, that is fine.
There are other easy ways to support the project and show your appreciation,
which we would also be very happy about:</p>
<ul>
<li>Star the <a href="https://github.com/rustprooflabs/pgosm-flex">project on GitHub</a>.</li>
<li>Blog or otherwise post about it on the social media of your choice.</li>
<li>Refer to this project in your project's readme.</li>
<li>Tell your friends / colleagues.</li>
<li>Mention the project at local meetups.</li>
</ul>
</blockquote>
<h2 id="code-of-conduct"><a class="header" href="#code-of-conduct">Code of Conduct</a></h2>
<p>This project and everyone participating in it is governed by the
<a href="code-of-conduct.html">Code of Conduct</a>.
By participating, you are expected to uphold this code.
Please report unacceptable behavior to <a href="mailto:support@rustprooflabs.com">the maintainers</a>.</p>
<h2 id="ways-to-contribute"><a class="header" href="#ways-to-contribute">Ways to Contribute</a></h2>
<p>The PgOSM Flex project is managed on GitHub.  GitHub provides multiple ways to
interact with and contribute to this project, including
<a href="https://github.com/rustprooflabs/pgosm-flex/discussions/">discussions</a>,
<a href="https://github.com/rustprooflabs/pgosm-flex/issues">issues</a>,
and <a href="https://github.com/rustprooflabs/pgosm-flex/pulls">pull requests (PRs)</a>.
A GitHub account is required for many interactions with the community, such as
creating issues, leaving comments, and many other actions available through GitHub.
The following sections explain various ways to use these GitHub features to
contribute and otherwise interact with the community.</p>
<h3 id="discussions-questions-ideas-show--tell"><a class="header" href="#discussions-questions-ideas-show--tell">Discussions: Questions, Ideas, Show &amp; Tell</a></h3>
<p>Before asking a question, search for existing
<a href="https://github.com/rustprooflabs/pgosm-flex/discussions">discussions</a>
and <a href="https://github.com/rustprooflabs/pgosm-flex/issues">issues</a>
that might address your question.
If you find a suitable item yet still need clarification,
write your question as a comment on the existing item to keep the discussion in
a consolidated location.
It is also advisable to search this documentation and the internet for answers first.</p>
<p>If your question is not already being addressed, start a new
<a href="https://github.com/rustprooflabs/pgosm-flex/discussions/new/choose">Discussion</a>
with as much context and detail as possible.
GitHub provides discussion types for
<a href="https://github.com/rustprooflabs/pgosm-flex/discussions/new?category=q-a">Q &amp; A</a>,
<a href="https://github.com/rustprooflabs/pgosm-flex/discussions/new?category=ideas">Discussions</a>,
<a href="https://github.com/rustprooflabs/pgosm-flex/discussions/new?category=show-and-tell">Show and Tell</a>
and more.  If a question turns into the discovery of a bug or feature request,
Discussions can be converted into issues.</p>
<h4 id="list-your-project"><a class="header" href="#list-your-project">List Your Project</a></h4>
<p>The PgOSM Flex project encourages you to <a href="/projects.html">list your project</a>
using PgOSM Flex. The easiest way to start this is to open a
<a href="https://github.com/rustprooflabs/pgosm-flex/discussions/new?category=show-and-tell">Show and Tell</a>
discussion.  Explain how PgOSM Flex is used in your project, if you have a blog post
or other easy ways to show this, make sure to add links!</p>
<h3 id="issues-enhancements-and-bugs"><a class="header" href="#issues-enhancements-and-bugs">Issues: Enhancements and Bugs</a></h3>
<p>This section guides you through submitting GitHub issues for PgOSM Flex. Issues
are used to suggest completely new features, minor improvements, and report bugs.</p>
<p>Following these guidelines will help maintainers and the community understand
your suggestion and make PgOSM Flex as useful and bug-free as possible.</p>
<h4 id="before-submitting-an-issue"><a class="header" href="#before-submitting-an-issue">Before Submitting an Issue</a></h4>
<ul>
<li>Make sure that you are using the latest version.</li>
<li>Read the <a href="/index.html">documentation</a> to see if your topic is already covered</li>
<li>Search <a href="https://github.com/rustprooflabs/pgosm-flex/issues">existing isues</a> to see if there is already an open issue on the topic. If there is an existing issue, add a comment there instead of opening a new issue.</li>
<li>Find out whether your idea fits with the scope and <a href="index.html#project-goals">aims of the project</a>. It's up to you to make a strong case to convince the project's developers of the merits of this feature. Keep in mind that we want features that will be useful to the majority of our users and not just a small subset. If you're just targeting a minority of users, consider writing an add-on/plugin library.</li>
</ul>
<h4 id="feature-request"><a class="header" href="#feature-request">Feature Request</a></h4>
<p>Feature requests are tracked as
<a href="https://github.com/rustprooflabs/pgosm-flex/issues">GitHub issues</a>.</p>
<ul>
<li>Use a <strong>clear and descriptive title</strong> for the issue to identify the suggestion.</li>
<li>Provide a <strong>step-by-step description of the suggested enhancement</strong> in as many details as possible.</li>
<li><strong>Describe the current behavior</strong> and <strong>explain which behavior you expected to see instead</strong> and why. At this point you can also tell which alternatives do not work for you.</li>
<li><strong>Explain why this enhancement would be useful</strong> to PgOSM Flex users.</li>
</ul>
<h4 id="bug-report"><a class="header" href="#bug-report">Bug Report</a></h4>
<p>A bug report indicates PgOSM Flex is not working as advertised or expected.
Use the <a href="https://github.com/rustprooflabs/pgosm-flex/issues/new?assignees=&amp;labels=&amp;projects=&amp;template=bug_report.md&amp;title=">bug report template</a> to submit your issue.  Fill in
detailed information for as many of the sections as possible.</p>
<p>The bug report template includes a series of headers
(defined as lines starting with <code>#</code> symbols) with comments prompting you for input.
Use the "Write" and "Preview" tabs in the GitHub interface to edit and preview your issue.</p>
<ul>
<li>Make sure that you are using the latest version.</li>
<li>Make sure that you have read the <a href="/index.html">documentation</a>.</li>
<li>Determine if your bug is really a bug and not an error on your side e.g. using incompatible environment components/versions.</li>
<li>To see if other users have experienced (and potentially already solved) the same issue you are having, check if there is not already a bug report existing for your bug or error in the <a href="https://github.com/rustprooflabs/pgosm-flex/issues">issues</a>.</li>
</ul>
<h4 id="security-advisory"><a class="header" href="#security-advisory">Security Advisory</a></h4>
<p>Security related concerns should be submitted using GitHub's
<a href="https://github.com/rustprooflabs/pgosm-flex/security/advisories/new">Security Advisory</a>
feature.  This provides a secure method to communicate with project maintainers.</p>
<p>RustProof Labs makes security a top priority and will address any security concerns
as quickly as possible.</p>
<h4 id="once-its-submitted"><a class="header" href="#once-its-submitted">Once it's submitted</a></h4>
<p>After you have submitted an issue, the project team will label the issue accordingly.
Maintainers will try to reproduce the issue with your provided steps. If there are no reproduction steps or no obvious way to reproduce the issue, the team will ask you for more details.</p>
<h3 id="improving-documentation"><a class="header" href="#improving-documentation">Improving Documentation</a></h3>
<p>See the <code>README.md</code> in the <a href="https://github.com/rustprooflabs/pgosm-flex/tree/main/docs"><code>pgosm-flex/docs</code> directory</a>.</p>
<h2 id="submitting-pull-requests"><a class="header" href="#submitting-pull-requests">Submitting Pull Requests</a></h2>
<p>This project uses Pull Requests (PRs) like so many other open source projects.
Fork the project into your own repository, create a feature branch there,
and make one or more pull requests back to the main PgOSM Flex repository
targeting the <code>dev</code> branch. Your PR can then be reviewed and discussed.</p>
<blockquote>
<p>Helpful: Run <code>make</code> in the project root directory and ensure all tests pass.
If tests are not passing and you need help resolving the problem, please mention this in your PR.</p>
</blockquote>
<h2 id="adding-new-feature-layers"><a class="header" href="#adding-new-feature-layers">Adding new feature layers</a></h2>
<p>Feature <a href="layersets.html#layers">Layers</a> define the data loaded by PgOSM Flex into
the target Postgres / PostGIS database.</p>
<p>Checklist for adding new feature layers:</p>
<ul>
<li><input disabled="" type="checkbox"/>
Create <code>flex-config/style/&lt;feature&gt;.lua</code></li>
<li><input disabled="" type="checkbox"/>
Create <code>flex-config/sql/&lt;feature&gt;.sql</code></li>
<li><input disabled="" type="checkbox"/>
Update <code>flex-config/run.lua</code></li>
<li><input disabled="" type="checkbox"/>
Update <code>flex-config/run.sql</code></li>
<li><input disabled="" type="checkbox"/>
Update <code>db/qc/features_not_in_run_all.sql</code></li>
<li><input disabled="" type="checkbox"/>
Add relevant <code>tests/sql/&lt;feature_queries&gt;.sql</code></li>
<li><input disabled="" type="checkbox"/>
Add relevant <code>tests/expected/&lt;feature_queries&gt;.out</code></li>
</ul>
<h2 id="style-guides"><a class="header" href="#style-guides">Style guides</a></h2>
<h3 id="written-content-in-github"><a class="header" href="#written-content-in-github">Written content in GitHub</a></h3>
<p>See <a href="https://docs.github.com/en/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax">GitHub's Markdown documentation</a>
for more on writing with formatting in GitHub.</p>
<ul>
<li>Use headers to outline sections when using more than two or three paragraphs.</li>
<li>Format <code>code</code> when using with inline text.</li>
<li>Use code blocks for multi-line code examples.</li>
</ul>
<h3 id="commit-messages"><a class="header" href="#commit-messages">Commit Messages</a></h3>
<p>Brief, descriptive commit messages are appreciated.  Lengthy commit messages
will likely never be reviewed.  Detailed explanations and discussions are appropriate
in GitHub Pull Request, Issues, and/or discussions.</p>
<h2 id="legal-notice"><a class="header" href="#legal-notice">Legal Notice</a></h2>
<p>When contributing to this project, you must agree that you have authored 100% of the content, that you have the necessary rights to the content and that the content you contribute may be provided under the project license.</p>
<h2 id="attribution"><a class="header" href="#attribution">Attribution</a></h2>
<p>This guide is loosely based on the
<a href="https://contributing.md/">example <strong>contributing.md</strong> site</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h1>
<p>The bulk of the PgOSM Flex user guide is written for <code>*nix</code> users.
The Quick Start, however, includes an additional section <a href="./windows.html">Running on Windows</a>
provides guidance for Windows users.  Windows users are advised to read
this section before continuing to the Windows specific steps, as many concepts
are not repeated in the Windows instructions.</p>
<h2 id="tldr"><a class="header" href="#tldr">TLDR;</a></h2>
<p>The following code block shows the commands needed to run PgOSM Flex.
The sections below provide explanations of these commands.</p>
<pre><code class="language-bash">mkdir ~/pgosm-data
export POSTGRES_USER=postgres
export POSTGRES_PASSWORD=mysecretpassword

# Ensure you have the latest Docker image
docker pull rustprooflabs/pgosm-flex

docker run --name pgosm -d --rm \
    -v ~/pgosm-data:/app/output \
    -v /etc/localtime:/etc/localtime:ro \
    -e POSTGRES_USER=$POSTGRES_USER \
    -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
    -p 5433:5432 -d rustprooflabs/pgosm-flex

docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia
</code></pre>
<h2 id="pgosm-via-docker"><a class="header" href="#pgosm-via-docker">PgOSM via Docker</a></h2>
<p>The PgOSM Flex
<a href="https://hub.docker.com/r/rustprooflabs/pgosm-flex">Docker image</a>
is hosted on Docker Hub.
The image includes all the pre-requisite software and handles all of the options,
logic, and post-processing steps required.  Features include:</p>
<ul>
<li>Automatic data download from Geofabrik and validation against checksum</li>
<li>Custom Flex layers built in Lua</li>
<li>Mix and match layers using Layersets</li>
<li>Loads to Docker-internal Postgres, or externally defined Postgres</li>
<li>Supports <code>osm2pgsql-replication</code> and <code>osm2pgsql --append</code> mode</li>
<li>Export processed data via <code>pg_dump</code> for loading into additional databases</li>
</ul>
<h2 id="docker-usage"><a class="header" href="#docker-usage">Docker usage</a></h2>
<p>This section outlines a typical import using Docker to run PgOSM Flex.</p>
<h3 id="prepare"><a class="header" href="#prepare">Prepare</a></h3>
<p>Create a directory to use a common location to share with the Docker container.
This is used to link to the internal path where the <code>.osm.pbf</code> file, <code>.md5</code> file,
and (optional) output <code>.sql</code> files are saved.</p>
<pre><code class="language-bash">mkdir ~/pgosm-data
</code></pre>
<h3 id="run"><a class="header" href="#run">Run</a></h3>
<p>Set environment variables for the temporary Postgres connection in Docker.
These are required for the Docker container to run.</p>
<pre><code class="language-bash">export POSTGRES_USER=postgres
export POSTGRES_PASSWORD=mysecretpassword
</code></pre>
<p>Start the <code>pgosm</code> Docker container. At this point, Postgres / PostGIS
is available on port <code>5433</code>.</p>
<pre><code class="language-bash">docker run --name pgosm -d --rm \
    -v ~/pgosm-data:/app/output \
    -v /etc/localtime:/etc/localtime:ro \
    -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
    -p 5433:5432 -d rustprooflabs/pgosm-flex
</code></pre>
<h3 id="check-docker-container-running"><a class="header" href="#check-docker-container-running">Check Docker container running</a></h3>
<p>It is worth verifying the Docker container is successfully running with <code>docker ps -a</code>.
Check for a <code>STATUS</code> similar to <code>Up 4 seconds</code> shown in the example output below.</p>
<pre><code class="language-bash">$ docker ps -a

CONTAINER ID   IMAGE                      COMMAND                  CREATED         STATUS         PORTS                                       NAMES
e7f80926a823   rustprooflabs/pgosm-flex   "docker-entrypoint.s…"   5 seconds ago   Up 4 seconds   0.0.0.0:5433-&gt;5432/tcp, :::5433-&gt;5432/tcp   pgosm
</code></pre>
<h3 id="execute-pgosm-flex"><a class="header" href="#execute-pgosm-flex">Execute PgOSM Flex</a></h3>
<p>Use <code>docker exec</code> to run the processing for the Washington D.C subregion.
This example uses three (3) parameters to specify the total system RAM (8 GB)
along with a region/subregion.</p>
<ul>
<li>Total RAM for osm2pgsql, Postgres and OS (<code>8</code>)</li>
<li>Region (<code>north-america/us</code>)</li>
<li>Sub-region (<code>district-of-columbia</code>) (Optional)</li>
</ul>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia
</code></pre>
<p>The above command takes roughly 1 minute to run if the PBF for today
has already been downloaded.
If the PBF is not downloaded it will depend on how long
it takes to download the 17 MB PBF file + ~ 1 minute processing.</p>
<h2 id="after-processing"><a class="header" href="#after-processing">After processing</a></h2>
<p>The processed OpenStreetMap data is also available in the Docker container on port <code>5433</code>.
You can connect and query directly in the Docker container.</p>
<pre><code class="language-bash">psql -h localhost -p 5433 -d pgosm -U postgres -c "SELECT COUNT(*) FROM osm.road_line;"

┌───────┐
│ count │
╞═══════╡
│ 39865 │
└───────┘
</code></pre>
<p>The <code>~/pgosm-data</code> directory has two (2) files from a typical single run.
The PBF file and its MD5 checksum have been renamed with the date in the filename.
This enables loading the file downloaded today
again in the future, either with the same version of PgOSM Flex or the latest version. The <code>docker exec</code> command uses the <code>PGOSM_DATE</code> environment variable
to load these historic files.</p>
<p>If <code>--pg-dump</code> option is used the output <code>.sql</code> is also saved in
the <code>~/pgosm-data</code> directory.
This <code>.sql</code> file can be loaded into any other database with PostGIS and the proper
permissions.</p>
<pre><code class="language-bash">ls -alh ~/pgosm-data/

-rw-r--r-- 1 root     root      18M Jan 21 03:45 district-of-columbia-2023-01-21.osm.pbf
-rw-r--r-- 1 root     root       70 Jan 21 04:39 district-of-columbia-2023-01-21.osm.pbf.md5
-rw-r--r-- 1 root     root     163M Jan 21 16:14 north-america-us-district-of-columbia-default-2023-01-21.sql
</code></pre>
<h2 id="meta-table"><a class="header" href="#meta-table">Meta table</a></h2>
<p>PgOSM Flex tracks processing metadata in the <code>osm.pgosm_flex</code>  table. The initial import
has <code>osm2pgsql_mode = 'create'</code>, the subsequent update has
<code>osm2pgsql_mode = 'append'</code>.</p>
<pre><code class="language-sql">SELECT osm_date, region, srid,
        pgosm_flex_version, osm2pgsql_version, osm2pgsql_mode
    FROM osm.pgosm_flex
;
</code></pre>
<pre><code class="language-bash">┌────────────┬───────────────────────────┬──────┬────────────────────┬───────────────────┬────────────────┐
│  osm_date  │          region           │ srid │ pgosm_flex_version │ osm2pgsql_version │ osm2pgsql_mode │
╞════════════╪═══════════════════════════╪══════╪════════════════════╪═══════════════════╪════════════════╡
│ 2022-11-04 │ north-america/us-colorado │ 3857 │ 0.6.2-e1f140f      │ 1.7.2             │ create         │
│ 2022-11-25 │ north-america/us-colorado │ 3857 │ 0.6.2-e1f140f      │ 1.7.2             │ append         │
└────────────┴───────────────────────────┴──────┴────────────────────┴───────────────────┴────────────────┘
</code></pre>
<h2 id="explore-data-loaded"><a class="header" href="#explore-data-loaded">Explore data loaded</a></h2>
<p>A peek at some of the tables loaded.
This query requires the
<a href="https://github.com/rustprooflabs/pgdd">PostgreSQL Data Dictionary (PgDD) extension</a>,
use <code>\dt+ osm.*</code> in <code>psql</code> for similar details.</p>
<pre><code class="language-sql">SELECT s_name, t_name, rows, size_plus_indexes 
    FROM dd.tables 
    WHERE s_name = 'osm' 
    ORDER BY t_name LIMIT 10;
</code></pre>
<pre><code class="language-bash">    ┌────────┬──────────────────────┬────────┬───────────────────┐
    │ s_name │        t_name        │  rows  │ size_plus_indexes │
    ╞════════╪══════════════════════╪════════╪═══════════════════╡
    │ osm    │ amenity_line         │      7 │ 56 kB             │
    │ osm    │ amenity_point        │   5796 │ 1136 kB           │
    │ osm    │ amenity_polygon      │   7593 │ 3704 kB           │
    │ osm    │ building_point       │    525 │ 128 kB            │
    │ osm    │ building_polygon     │ 161256 │ 55 MB             │
    │ osm    │ indoor_line          │      1 │ 40 kB             │
    │ osm    │ indoor_point         │      5 │ 40 kB             │
    │ osm    │ indoor_polygon       │    288 │ 136 kB            │
    │ osm    │ infrastructure_point │    884 │ 216 kB            │
    │ osm    │ landuse_point        │     18 │ 56 kB             │
    └────────┴──────────────────────┴────────┴───────────────────┘
</code></pre>
<h2 id="one-table-to-rule-them-all"><a class="header" href="#one-table-to-rule-them-all">One table to rule them all</a></h2>
<p>From the perspective of database design, the <code>osm.unitable</code> option is the <strong>worst</strong>!
This table violates all sorts of best practices established in this project
by shoving all features into a single unstructured table.</p>
<blockquote>
<p>This style included in PgOSM Flex is intended to be used for troubleshooting and quality control.  It is not intended to be used for real production workloads! This table is helpful for exploring the full data set when you don't really know what you are looking for, but you know <strong>where</strong> you are looking.</p>
</blockquote>
<p>Unitable is loaded with the <code>everything</code> layerset.  Feel free to create your own
customized layerset if needed.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia \
    --layerset=everything
</code></pre>
<blockquote>
<p>The <code>unitable.lua</code> script included in this project was <a href="https://github.com/openstreetmap/osm2pgsql/blob/master/flex-config/unitable.lua">adapted from the unitable example from osm2pgsql</a>. This version uses <code>JSONB</code> instead of <code>HSTORE</code>, and takes advantage of <code>helpers.lua</code> to easily customize SRID.</p>
</blockquote>
<h2 id="jsonb-support"><a class="header" href="#jsonb-support">JSONB support</a></h2>
<p>PgOSM-Flex uses <code>JSONB</code> in Postgres to store the raw OpenStreetMap
key/value data (<code>tags</code> column) and relation members (<code>member_ids</code>).
The <code>tags</code> column only exists in the <code>osm.tags</code> and <code>osm.unitable</code> tables.
The <code>member_ids</code> column is included in:</p>
<ul>
<li><code>osm.place_polygon</code></li>
<li><code>osm.poi_polygon</code></li>
<li><code>osm.public_transport_line</code></li>
<li><code>osm.public_transport_polygon</code></li>
<li><code>osm.road_line</code></li>
<li><code>osm.road_major</code></li>
<li><code>osm.road_polygon</code></li>
</ul>
<h2 id="additional-resources"><a class="header" href="#additional-resources">Additional resources</a></h2>
<p>Blog posts covering various details and background information.</p>
<ul>
<li><a href="https://blog.rustprooflabs.com/2022/10/announce-mastering-postgis-openstreemap">Book Release! Mastering PostGIS and OpenStreetMap</a></li>
<li><a href="https://blog.rustprooflabs.com/2021/01/pgosm-flex-improved-openstreetmap-places-postgis">Better OpenStreetMap places in PostGIS</a></li>
<li><a href="https://blog.rustprooflabs.com/2021/01/postgis-openstreetmap-flex-structure">Improved OpenStreetMap data structure in PostGIS</a></li>
<li><a href="https://blog.rustprooflabs.com/2020/12/osm2gpsql-flex-output-to-postgis">Hands on with osm2pgsql's new Flex output</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pgosm-flex-on-windows"><a class="header" href="#pgosm-flex-on-windows">PgOSM Flex on Windows</a></h1>
<p>PgOSM Flex can be used on Windows via Docker Desktop.
This page outlines a few Windows-specific steps where they deviate from the experience
on Linux.</p>
<h2 id="install-docker-desktop"><a class="header" href="#install-docker-desktop">Install Docker Desktop</a></h2>
<p>The Docker documentation <a href="https://docs.docker.com/desktop/install/windows-install/">has instructions</a>
to install Docker Desktop on Windows.  There is a link toward the top of that page to download
the latest installer.
The installation steps are under the
<a href="https://docs.docker.com/desktop/install/windows-install/#install-docker-desktop-on-windows">Install Docker Desktop on Windows</a> section, with both interactive and
command line instructions.</p>
<blockquote>
<p>Note: If your Windows user is NOT the admin, you must also follow the steps
to add your user to the <code>docker-users</code> user group. Those steps are listed
after the main installation steps.</p>
</blockquote>
<h2 id="create-folder"><a class="header" href="#create-folder">Create Folder</a></h2>
<p>Create a <code>pgosm-data</code> folder under your user's Documents folder. This gives PgOSM Flex
a place to save files that you can access directly from your host Windows machine.</p>
<p>The following screenshot shows this folder with the <code>.pbf</code> and <code>.md5</code> files downloaded
to load Hawaii from 2024-02-15.</p>
<p><img src="/static/windows-docker-desktop-pgosm-data-folder.png" alt="Screenshot showing the Documents &gt; pgosm-data folder on Windows with the PBF and .md5 files from Hawaii" /></p>
<h2 id="download-pgosm-flex-image"><a class="header" href="#download-pgosm-flex-image">Download PgOSM Flex Image</a></h2>
<p>Search for the <code>rustprooflabs/pgosm-flex</code> Docker image via Docker Desktop.
Leave the "Latest" tag selected and click "Pull" to download the image.</p>
<p><img src="/static/windows-docker-desktop-download-image.png" alt="Screenshot showing the Image Search for pgosm-flex from Docker Hub" /></p>
<h2 id="run-docker-container"><a class="header" href="#run-docker-container">Run Docker Container</a></h2>
<p>The Images section of Docker Desktop lists the images available on your computer.
Click the Run button (play icon) on the right side of the line listing the PgOSM Flex
image.</p>
<p><img src="/static/windows-docker-desktop-run-container.png" alt="Screenshot showing the Run button from the page listing downloaded images." /></p>
<p>Expand the "Optional Settings" dialog on the Run dialog to enter details to run.
Setting the port to 5433 makes the in-Docker Postgres available to connect to from
your host machine.
The Volumes setting maps your load <code>pgosm-data</code> dirctory (under Documents) to
the Docker container's <code>/app/output</code> directory to make files used available.
The Environment Variables configure the internal database's superuser and password.
<strong>DO NOT USE THE PASSWORD SHOWN HERE!</strong></p>
<p><img src="/static/windows-docker-desktop-run-container-optional-settings.png" alt="Screenshot showing the optional settings filled in on the Run dialog from Docker Desktop on Windows." /></p>
<blockquote>
<p>Note: These Windows instructions explain the basic Environment Variables matching
the ones used in the main <a href="/quick-start.html">Quick Start</a> guide.  There are not
equivalent Windows pages for all of the advanced customizations available.
For these options, review the main instructions for the command line usage
and convert them to the Docker Desktop equivalents.</p>
</blockquote>
<p>When running the container you might be prompted by Windows Defender about Docker Desktop
and the firewall.  Most users should click Cancel on this step. You do not need to "Allow access"
in order to connect to your Docker container from the computer running Docker.</p>
<blockquote>
<p>You should understand the risks of opening up the Postgres port in your firewall.  This topic is beyond the scope of this documentation.</p>
</blockquote>
<p><img src="/static/windows-docker-desktop-run-container-firewall.png" alt="Screenshot showing the Windows Defender dialog asking about opening ports in the Firewall, which requires Admin permissions.  Most users will click cancel." /></p>
<p>The "Logs" tab for the new running container should display the output from the backend
starting up. The final line from starting up should read
"<code>database system is ready to accept connections</code>."  At this point the internal
Postgres service is running and ready.</p>
<p><img src="/static/windows-docker-desktop-run-container-logs.png" alt="Screenshot showing the log output automatically displayed when running the PgOSM Flex Docker container." /></p>
<h2 id="docker-exec"><a class="header" href="#docker-exec">Docker exec</a></h2>
<p>Switch to the "Exec" tab of the running pgosm container.  This interface allows
running commands inside the Docker container.  This provides the <code>docker exec -it pgosm</code>
functionality used on the command line elsewhere throughout this documentation.</p>
<p><img src="/static/windows-docker-desktop-pgosm-exec-ready.png" alt="Screenshot showing the &quot;exec&quot; tab ready for a command to run" /></p>
<p>Enter the command to run in the container.</p>
<pre><code class="language-bash">python3 docker/pgosm_flex.py --ram=2 --region=north-america/us --subregion=hawaii
</code></pre>
<p>The following screenshot shows this command being ran and the initial portion of
the output from processing.</p>
<p><img src="/static/windows-docker-desktop-pgosm-exec.png" alt="Screenshot showing the &quot;exec&quot; tab in the running Docker container." /></p>
<blockquote>
<p>Docker Desktop handles the <code>exec</code> functionality.  Commands ran via Docker Desktop
exclude the <code>docker exec -it pgosm</code> seen throughout the remainder of this documentation.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="customize-pgosm-flex"><a class="header" href="#customize-pgosm-flex">Customize PgOSM Flex</a></h1>
<ul>
<li><a href="./common-customization.html">Common Customizations</a></li>
<li><a href="./layersets.html">Layersets</a></li>
<li><a href="./layers.html">Layers</a></li>
<li><a href="./configure-postgres.html">Configure Postgres</a></li>
<li><a href="./data-files.html">Data Files</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="common-customizations"><a class="header" href="#common-customizations">Common Customizations</a></h1>
<p>A major goal of PgOSM Flex is support a wide range of use cases for using
OpenStreetMap data in PostGIS. This chapter explores a few ways PgOSM Flex
can be customized.</p>
<h2 id="selecting-region-and-subregion"><a class="header" href="#selecting-region-and-subregion">Selecting region and subregion</a></h2>
<p>The most used customization is the region and subregion selection.
The examples throughout this project's documentation use
the <code>--region=north-america/us</code> and <code>--subregion=district-of-columbia</code>
because it is a small region that downloads and imports quickly.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia
</code></pre>
<p>By default PgOSM Flex will attempt to download the necessary data files
from <a href="https://download.geofabrik.de/">Geofabrik's download server</a>.
Navigate the Region/Sub-region structure on Geofabrik to determine
exactly what <code>--region</code> and <code>--subregion</code> options to choose.
This can be a bit confusing as larger subregions can contain smaller subregions.
Feel free to <a href="https://github.com/rustprooflabs/pgosm-flex/discussions/new/choose">start a discussion</a> if you need help figuring this part out!</p>
<blockquote>
<p>See the <a href="data-files.html">Data Files</a> section for steps to change this behavior.</p>
</blockquote>
<p>If you want to load the entire United States subregion, instead of
the District of Columbia subregion, the <code>docker exec</code> command is changed to the
following.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america \
    --subregion=us
</code></pre>
<p>For top-level regions, such as North America, leave off the <code>--subregion</code> option.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america
</code></pre>
<h2 id="customize-load-to-postgis"><a class="header" href="#customize-load-to-postgis">Customize load to PostGIS</a></h2>
<p>There are a few ways to customize exactly how data is loaded to PostGIS / Postgres.</p>
<h3 id="srid"><a class="header" href="#srid">SRID</a></h3>
<p>PgOSM Flex defaults to SRID 3857 matching the default osm2pgsql behavior.
This can be customized using <code>--srid 4326</code> or any other SRID supported by
osm2pgsql and PostGIS.</p>
<h3 id="schema-name"><a class="header" href="#schema-name">Schema name</a></h3>
<blockquote>
<p>Experimental, added for v0.10.1.</p>
</blockquote>
<p>The <code>--schema-name</code> option allows customizing the schema name from the default
of <code>osm</code>. The schema name option allows loading multiple source files into
multiple regions.</p>
<p>While schema name can be customized when using <code>--replication</code>, it
<a href="/replication.html#one-replication-source">cannot be used to load multiple regions</a>
with replication.</p>
<h3 id="language"><a class="header" href="#language">Language</a></h3>
<p>The <code>--language</code> option enables defining a preferred language for OpenStreetMap
names.  If <code>--language=en</code> is defined, PgOSM Flex's <code>helper.get_name()</code>
function will use <code>name:en</code> if it exists.  The usage and effect
of this option is shown in <a href="https://github.com/rustprooflabs/pgosm-flex/issues/93#issuecomment-818271870">this comment</a>.</p>
<p>Using <code>-e PGOSM_LANGUAGE=kn</code> for U.S. West results in most state labels picking
up the Kannada language option.  The states without a <code>name:kn</code> default
to the standard name selection logic.</p>
<p><img src="https://user-images.githubusercontent.com/3085224/114467942-ecd29700-9ba7-11eb-980a-10a127fd3c97.png" alt="" /></p>
<h3 id="data-only"><a class="header" href="#data-only">Data only</a></h3>
<p>The <code>--data-only</code> option skips creating optional data structures in the target
database.  This includes the helper tables in the <code>pgosm</code> schema and the
QGIS layer style table.</p>
<h2 id="skip-nested-place-polygons"><a class="header" href="#skip-nested-place-polygons">Skip nested place polygons</a></h2>
<p>The nested place polygon calculation
(<a href="https://blog.rustprooflabs.com/2021/01/pgosm-flex-improved-openstreetmap-places-postgis">explained in this post</a>)
adds minimal overhead to smaller regions, e.g. Colorado with a 225 MB PBF input file.
Larger regions, such as North America (12 GB PBF),
are impacted more severely as a difference in processing time.
Calculating nested place polygons for Colorado adds less than 30 seconds on an 8 minute process,
taking about 5% longer.
A larger region, such as North America, can take 33% longer adding more than
an hour and a half to the total processing time.
See the <a href="performance.html">performance section</a> for more details.</p>
<p>Use <code>--skip-nested</code> to bypass the calculation of nested admin polygons.</p>
<h2 id="use---pg-dump-to-export-data"><a class="header" href="#use---pg-dump-to-export-data">Use <code>--pg-dump</code> to export data</a></h2>
<blockquote>
<p>The <code>--pg-dump</code> option was added in 0.7.0.  Prior versions defaulted to using <code>pg_dump</code> and provided a <code>--skip-dump</code> option to override.  The default now is to only use <code>pg_dump</code> when requested.  See <a href="https://github.com/rustprooflabs/pgosm-flex/issues/266">#266</a> for more.</p>
</blockquote>
<p>A <code>.sql</code> file can be created using <code>pg_dump</code> as part of the processing
for easy loading into one or more external Postgres databases.
Add <code>--pg-dump</code> to the <code>docker exec</code> command to enable this feature.</p>
<p>The following example
creates an empty <code>myosm</code> database to load the processed and dumped OpenStreetMap
data.</p>
<pre><code class="language-bash">psql -d postgres -c "CREATE DATABASE myosm;"
psql -d myosm -c "CREATE EXTENSION postgis;"

psql -d myosm \
    -f ~/pgosm-data/pgosm-flex-north-america-us-district-of-columbia-default-2023-01-21.sql
</code></pre>
<blockquote>
<p>The above assumes a database user with <code>superuser</code> permissions is used. See the <a href="postgres-permissions.html">Postgres Permissions</a> section for a more granular approach to permissions.</p>
</blockquote>
<h2 id="use---help"><a class="header" href="#use---help">Use <code>--help</code></a></h2>
<p>The PgOSM Docker image can provide command line help.
The Python script that controls PgOSM Flex's behavior is built using the
<code>click</code> module, providing built-in <code>--help</code>.
Use <code>docker exec</code> to show the full help.</p>
<pre><code class="language-bash">docker exec -it pgosm python3 docker/pgosm_flex.py --help
</code></pre>
<p>The first portion of the <code>--help</code> output is shown here.</p>
<pre><code class="language-bash">Usage: pgosm_flex.py [OPTIONS]

  Run PgOSM Flex within Docker to automate osm2pgsql flex processing.

Options:
  --ram FLOAT               Amount of RAM in GB available on the machine
                            running the Docker container. This is used to
                            determine the appropriate osm2pgsql command via
                            osm2pgsql-tuner recommendation engine.  [required]
  --region TEXT             Region name matching the filename for data sourced
                            from Geofabrik. e.g. north-america/us. Optional
                            when --input-file is specified, otherwise
                            required.
  --subregion TEXT          Sub-region name matching the filename for data
                            sourced from Geofabrik. e.g. district-of-columbia
  --data-only               When set, skips running Sqitch and importing QGIS
                            Styles.

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="layersets"><a class="header" href="#layersets">Layersets</a></h1>
<p>A layerset in PgOSM Flex defines one or more layers, where each layer
includes one or more <a href="layersets.html#tables">tables</a>.  For example, the
<code>minimal</code> layerset (see <a href="https://github.com/rustprooflabs/pgosm-flex/blob/main/flex-config/layerset/minimal.ini">flex-config/layerset/minimal.ini</a>)
is defined as shown in the following snippet.</p>
<pre><code class="language-ini">[layerset]
place=true
poi=true
road_major=true
</code></pre>
<p>In the above example, <code>place</code>, <code>poi</code> and <code>road_major</code> are the included
Layers.  This results in nine (9) total tables being loaded.
There is the standard
<a href="quick-start.html#meta-table">meta table <code>osm.pgosm_flex</code></a>, plus eight (8)
tables for the three (3) layers.  The place layer has four tables,
poi has three (3) and road major has one (1).</p>
<pre><code>┌────────┬──────────────────────┬───────┬───────────────────┐
│ s_name │        t_name        │ rows  │ size_plus_indexes │
╞════════╪══════════════════════╪═══════╪═══════════════════╡
│ osm    │ pgosm_flex           │     1 │ 32 kB             │
│ osm    │ place_line           │   128 │ 168 kB            │
│ osm    │ place_point          │   124 │ 128 kB            │
│ osm    │ place_polygon        │   217 │ 496 kB            │
│ osm    │ place_polygon_nested │    22 │ 304 kB            │
│ osm    │ poi_line             │   255 │ 128 kB            │
│ osm    │ poi_point            │ 10876 │ 2360 kB           │
│ osm    │ poi_polygon          │ 12413 │ 6456 kB           │
│ osm    │ road_major           │  8097 │ 2504 kB           │
└────────┴──────────────────────┴───────┴───────────────────┘
</code></pre>
<h2 id="included-layersets"><a class="header" href="#included-layersets">Included layersets</a></h2>
<p>PgOSM Flex includes a few layersets to get started as examples.
These layersets are defined under <code>flex-config/layerset/</code>.
If the <code>--layerset</code> is not defined, the <code>default</code> layerset is used.</p>
<ul>
<li><code>basic</code></li>
<li><code>default</code></li>
<li><code>everything</code></li>
<li><code>minimal</code></li>
</ul>
<p>Using a built-in layerset other than <code>default</code> is done by defining
the <code>--layerset</code> option.  The following example uses the <code>minimal</code> layerset
shown above.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --layerset=minimal \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia
</code></pre>
<p>The output from running PgOSM Flex indicates which layers are being loaded.</p>
<pre><code>2023-01-29 08:47:12,191:INFO:pgosm-flex:helpers:Including place
2023-01-29 08:47:12,192:INFO:pgosm-flex:helpers:Including poi
2023-01-29 08:47:12,192:INFO:pgosm-flex:helpers:Including road_major
</code></pre>
<h2 id="custom-layerset"><a class="header" href="#custom-layerset">Custom layerset</a></h2>
<p>A layerset including the <code>poi</code> and <code>road_major</code> layers would look
like:</p>
<pre><code class="language-ini">[layerset]
poi=true
road_major=true
</code></pre>
<p>To use the <code>--layerset-path</code> option for custom layerset
definitions, link the directory containing custom styles
to the Docker container in the <code>docker run</code> command.
If the <code>custom-layerset</code> directory is in the home (<code>~</code>) directory, adding
<code>-v ~/custom-layerset:/custom-layerset \</code> to the <code>docker run</code>
command will make the layerset definition available to the Docker container.
The custom styles will be available inside the container under
<code>/custom-layerset</code>.</p>
<pre><code class="language-bash">docker run --name pgosm -d --rm \
    -v ~/pgosm-data:/app/output \
    -v /etc/localtime:/etc/localtime:ro \
    -v ~/custom-layerset:/custom-layerset \
    -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
    -p 5433:5432 -d rustprooflabs/pgosm-flex
</code></pre>
<p>Define the layerset name (<code>--layerset=poi</code>) and path
(<code>--layerset-path</code>) to the <code>docker exec</code> command.
The value provided to <code>--layerset-path</code> must match the path linked in the
<code>docker exec</code> command.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --layerset=poi \
    --layerset-path=/custom-layerset/ \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia
</code></pre>
<h2 id="excluding-layers"><a class="header" href="#excluding-layers">Excluding layers</a></h2>
<p>To exclude layers from a layerset they can be simply omitted from the
<code>.ini</code> file.  They can also be set explicitly to <code>false</code>
such as <code>road_major=false</code>.</p>
<h1 id="layers"><a class="header" href="#layers">Layers</a></h1>
<p>This section documents the layers created by PgOSM Flex. The
<a href="layersets.html">layerset</a> defined at runtime (to <code>docker exec</code>)
determines which tables are loaded, based on <code>layer_group</code>.</p>
<p>The <code>amenity</code> layer has each of the three types of geometry
commonly associated, so has three tables:</p>
<ul>
<li><code>osm.amenity_line</code></li>
<li><code>osm.amenity_point</code></li>
<li><code>osm.amenity_polygon</code></li>
</ul>
<p>The definitive answer to "what is in a layer" is defined by the
associated Lua code under <code>flex-config/style/&lt;layer group&gt;.lua</code></p>
<h2 id="layer-definitions"><a class="header" href="#layer-definitions">Layer definitions</a></h2>
<p>The layers are determined by the <code>.lua</code> files available
in the <a href="https://github.com/rustprooflabs/pgosm-flex/tree/main/flex-config/style"><code>flex-config/style</code></a>
directory.  Each <code>.lua</code> file in the <code>style</code> folder has a matching <code>.sql</code>
file in the <a href="https://github.com/rustprooflabs/pgosm-flex/tree/main/flex-config/sql"><code>flex-config/sql</code></a>
directory. For example,
the road layer is defined by <code>flex-config/style/road.lua</code> and
<code>flex-config/sql/road.sql</code>, and creates three (3) tables (<a href="layersets.html#tables">see Tables section</a>).</p>
<h2 id="tables"><a class="header" href="#tables">Tables</a></h2>
<p>Using <code>--layerset=everything</code> creates 45 tables and one (1)
materialized view.  The following table lists the groups of
tables created with the types of layer it is.</p>
<div class="table-wrapper"><table><thead><tr><th>Layer</th><th>Geometry Types</th></tr></thead><tbody>
<tr><td>amenity</td><td>line, point, polygon</td></tr>
<tr><td>building</td><td>point, polygon, combined</td></tr>
<tr><td>indoor</td><td>line, point, polygon</td></tr>
<tr><td>infrastructure</td><td>line, point, polygon</td></tr>
<tr><td>landuse</td><td>point, polygon</td></tr>
<tr><td>leisure</td><td>point, polygon</td></tr>
<tr><td>natural</td><td>line, point, polygon</td></tr>
<tr><td>place</td><td>line, point, polygon, <em>polygon_nested</em></td></tr>
<tr><td>poi</td><td>line, point, polygon, combined</td></tr>
<tr><td>public_transport</td><td>line, point, polygon</td></tr>
<tr><td>road</td><td>line, point, polygon</td></tr>
<tr><td>road_major</td><td>line (<em>table name is non-standard, <code>osm.road_major</code></em>)</td></tr>
<tr><td>shop</td><td>point, polygon, combined</td></tr>
<tr><td>tags</td><td><em>Provides full JSONB tags</em></td></tr>
<tr><td>traffic</td><td>line, point, polygon</td></tr>
<tr><td>unitable</td><td><em>generic <code>geometry</code></em></td></tr>
<tr><td>water</td><td>line, point, polygon</td></tr>
</tbody></table>
</div>
<h2 id="inclusion-by-openstreetmap-tags"><a class="header" href="#inclusion-by-openstreetmap-tags">Inclusion by OpenStreetMap tags</a></h2>
<p>Data is included in layers based on the tags from OpenStreetMap.</p>
<h3 id="amenity"><a class="header" href="#amenity">Amenity</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>amenity</li>
<li>bench</li>
<li>brewery</li>
</ul>
<h3 id="building"><a class="header" href="#building">Building</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>building</li>
<li>building:part</li>
<li>door</li>
<li>office</li>
</ul>
<p>Plus: Address only locations.</p>
<p>See <a href="https://github.com/rustprooflabs/pgosm-flex/issues/97">issue #97</a>
for more details about Address only locations.</p>
<h3 id="indoor"><a class="header" href="#indoor">Indoor</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>indoor</li>
<li>door</li>
<li>entrance</li>
</ul>
<h3 id="infrastructure"><a class="header" href="#infrastructure">Infrastructure</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>aeroway</li>
<li>amenity</li>
<li>emergency</li>
<li>highway</li>
<li>man_made</li>
<li>power</li>
<li>utility</li>
</ul>
<h3 id="landuse"><a class="header" href="#landuse">Landuse</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>landuse</li>
</ul>
<h3 id="leisure"><a class="header" href="#leisure">Leisure</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>leisure</li>
</ul>
<h3 id="natural"><a class="header" href="#natural">Natural</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>natural</li>
</ul>
<p>Excludes water/waterway values.  See <a href="layersets.html#water">Water section</a>.</p>
<h3 id="place"><a class="header" href="#place">Place</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>admin_level</li>
<li>boundary</li>
<li>place</li>
</ul>
<h3 id="poi-points-of-interest"><a class="header" href="#poi-points-of-interest">POI (Points of Interest)</a></h3>
<p>The POI layer overlaps many of the other existing layers, though with
slightly different definitions.  e.g. only buildings with either a
name and/or operator are included.</p>
<p>OpenStreetMap tags included:</p>
<ul>
<li>building</li>
<li>shop</li>
<li>amenity</li>
<li>leisure</li>
<li>man_made</li>
<li>tourism</li>
<li>landuse</li>
<li>natural</li>
<li>historic</li>
</ul>
<h3 id="public-transport"><a class="header" href="#public-transport">Public Transport</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>public_transport</li>
<li>aerialway</li>
<li>railway</li>
</ul>
<p>Additional important tags considered, but not used for primary selection:</p>
<ul>
<li>bus</li>
<li>railway</li>
<li>lightrail</li>
<li>train</li>
<li>highway</li>
</ul>
<h3 id="road"><a class="header" href="#road">Road</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>highway</li>
</ul>
<p>Additional important tags considered, but not used for primary selection:</p>
<ul>
<li>maxspeed</li>
<li>layer</li>
<li>tunnel</li>
<li>bridge</li>
<li>access</li>
<li>oneway</li>
</ul>
<h3 id="shop"><a class="header" href="#shop">Shop</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>shop</li>
<li>amenity</li>
</ul>
<h3 id="tags"><a class="header" href="#tags">Tags</a></h3>
<p>The <code>osm.tags</code> table stores all tags for all items loaded.</p>
<h3 id="traffic"><a class="header" href="#traffic">Traffic</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>highway</li>
<li>railway</li>
<li>barrier</li>
<li>traffic_calming</li>
<li>amenity</li>
<li>noexit</li>
</ul>
<h3 id="unitable"><a class="header" href="#unitable">Unitable</a></h3>
<p>All data is stuffed into a generic <code>GEOMETRY</code> column.</p>
<h3 id="water"><a class="header" href="#water">Water</a></h3>
<p>OpenStreetMap tags included:</p>
<ul>
<li>natural</li>
<li>waterway</li>
</ul>
<p>Uses specific <code>natural</code> types, attempts to avoid overlap
with the Natural layer. See the <a href="layersets.html#natural">Natural section</a>.</p>
<h2 id="views"><a class="header" href="#views">Views</a></h2>
<p>The need for views is diminishing as PgOSM Flex matures along with
osm2pgsql's Flex output.</p>
<p>The materialized view that will likely remain is:</p>
<ul>
<li><code>osm.vplace_polygon_subdivide</code></li>
</ul>
<p>The other views currently created in PgOSM Flex 0.8.x will
be removed in v0.9.0, see <a href="https://github.com/rustprooflabs/pgosm-flex/issues/320">issue #320</a>.</p>
<ul>
<li><code>osm.vbuilding_all</code></li>
<li><code>osm.vpoi_all</code></li>
<li><code>osm.vshop_all</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="indexes"><a class="header" href="#indexes">Indexes</a></h1>
<p>PgOSM Flex allows customizing the indexes on the tables using <code>.ini</code> files. The default
index configuration files are stored under <code>flex-config/indexes/</code>.
The default indexing strategy is baked into the Docker
image, to use the defaults you can follow the instructions throughout the
documentation without any adjustments.</p>
<blockquote>
<p>Custom indexes added in PgOSM Flex 0.10.0.</p>
</blockquote>
<h2 id="map-volume-in-docker-run"><a class="header" href="#map-volume-in-docker-run">Map Volume in <code>docker run</code></a></h2>
<p>To customize indexes, map the path of your custom index definitions folder
to the Docker container under <code>/app/flex-config/indexes</code>.  This overwrites the default
indexing scheme with the custom folder.  You must define an INI file for each of
the layers included by your chosen <code>layerset</code>.  The easiest approach is to copy the
existing directory with all of the index definitions, then customize those to
your needs.</p>
<p>The following command assumes you have the PgOSM Flex project cloned into the
<code>~/git/pgosm-flex</code> folder.  The <code>noindexes</code> example creates the PgOSM Flex
tables with only the required <code>PRIMARY KEY</code>s.</p>
<pre><code class="language-bash">docker run --name pgosm -d --rm \
    -v ~/pgosm-data:/app/output \
    -v /etc/localtime:/etc/localtime:ro \
    -v ~/git/pgosm-flex/flex-config/indexes/examples/noindexes:/app/flex-config/indexes \
    -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
    -p 5433:5432 -d rustprooflabs/pgosm-flex
</code></pre>
<blockquote>
<p>The <code>lotsofexamples</code> folder under <code>flex-config/indexes/examples/</code> illustrates creating indexes on nearly all columns.</p>
</blockquote>
<h2 id="ini-files"><a class="header" href="#ini-files">INI files</a></h2>
<p>Each Lua style (<code>flex-config/style/*.lua</code>) must have a matching INI file
under <code>flex-config/indexes/</code>.  Each <code>.ini</code> file should have 4 sections defined.
These sections can all be empty.</p>
<pre><code class="language-ini">[all]

[point]

[line]

[polygon]
</code></pre>
<p>Index settings in the <code>[all]</code> section will apply to all tables in the layer
unless specific tables override the setting.  Indexes in the <code>[point]</code>, <code>[line]</code>,
and <code>[polygon]</code> sections apply to only those specific tables.
The variables to use for indexes are described in the next section.</p>
<h2 id="index-variables"><a class="header" href="#index-variables">Index variables</a></h2>
<p>There are three (3) variables that can be configured for each column in the
PgOSM Flex database. <code>&lt;name&gt;</code> is the name of the column in the database.</p>
<ul>
<li><code>&lt;name&gt;</code></li>
<li><code>&lt;name&gt;_where</code></li>
<li><code>&lt;name&gt;_method</code></li>
</ul>
<blockquote>
<p>See the section <a href="custom-indexes.html#most-columns-can-be-indexed">Most Columns can be Indexed</a> for details about which columns can be indexed.</p>
</blockquote>
<h3 id="to-index-or-not-to-index"><a class="header" href="#to-index-or-not-to-index">To index or not to index</a></h3>
<p>The <code>&lt;name&gt;</code> variable is the column's name and is set to boolean.
To add an index to the <code>admin_level</code> column add <code>admin_level=true</code>.  To exclude
an index from a column either omit the column from the definition file, or
set it to <code>false</code>, e.g. <code>admin_level=false</code>.</p>
<h3 id="partial-indexes"><a class="header" href="#partial-indexes">Partial indexes</a></h3>
<p>Partial indexes can be created with the <code>&lt;name&gt;_where</code> variable.
The <code>admin_level</code> column can have a partial index created on rows where the
<code>admin_level</code> value is set using <code>admin_level_where=admin_level IS NOT NULL</code>.</p>
<pre><code class="language-ini">[all]
admin_level=true
admin_level_where=admin_level IS NOT NULL
</code></pre>
<h3 id="index-method"><a class="header" href="#index-method">Index method</a></h3>
<p>The <code>&lt;name&gt;_method</code> variable can be used to set the index method used by Postgres.
This value is passed to <code>osm2pgsql</code>'s <a href="https://osm2pgsql.org/doc/manual.html#defining-indexes">method option</a>, which appears to hand off to Postgres.  This should
allow any <a href="https://www.postgresql.org/docs/current/indexes-types.html">indexing method</a>
supported by Postgres.</p>
<p>One common way to use the <code>&lt;name&gt;_method</code> variable is to change a spatial
column's index from  <code>GIST</code> to <code>SPGIST</code> using <code>geom_method=spgist</code>.
<code>GEOMETRY</code> columns default to <code>GIST</code> and all other columns default to <code>BTREE</code>.</p>
<pre><code class="language-ini">[point]
geom=true
geom_method=spgist
</code></pre>
<blockquote>
<p>See Paul Ramsey's post <a href="https://www.crunchydata.com/blog/the-many-spatial-indexes-of-postgis">(The Many) Spatial Indexes of PostGIS</a> for more information about when to choose <code>SPGIST</code>.</p>
</blockquote>
<p>Setting index method isn't limited to spatial indexes. The following example
illustrates adding a <code>BRIN</code> index to the <code>admin_level</code> column.</p>
<pre><code class="language-ini">[all]
admin_level=true
admin_level_method=brin
</code></pre>
<h2 id="most-columns-can-be-indexed"><a class="header" href="#most-columns-can-be-indexed">Most columns can be indexed</a></h2>
<p>The only limit to which columns can be indexed is the <code>index_columns</code> list
defined in <code>flex_config/helpers.lua</code>.</p>
<blockquote>
<p>If there are columns that you would like to index this way submit either a pull request or create an issue requesting the change.</p>
</blockquote>
<h2 id="caveats"><a class="header" href="#caveats">Caveats</a></h2>
<p>Setting indexes is only relevant for the first import.  When using <code>--replication</code>
these configurations only impact the initial import. Subsequent imports make no
attempt to verify / adjust database indexes.</p>
<p>The primary key cannot be omitted using this approach.  The primary keys on
<code>osm_id</code> are created in post-processing SQL and is not able to be overridden
using this approach.</p>
<p>The simplest index specification file is shown above by defining the four (4)
empty sections define no indexes beyond the table's <code>PRIMARY KEY</code> on the <code>osm_id</code>
column.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configure-postgres-inside-docker"><a class="header" href="#configure-postgres-inside-docker">Configure Postgres inside Docker</a></h1>
<p>Add customizations with the <code>-c</code> switch, e.g. <code>-c shared_buffers=1GB</code>,
to customize Postgres' configuration at run-time in Docker.
See the <a href="https://osm2pgsql.org/doc/manual.html#preparing-the-database">osm2pgsql documentation</a>
for recommendations on a server with 64 GB of RAM.</p>
<p>This <code>docker run</code> command has been tested with 16GB RAM and 4 CPU (8 threads) with the Colorado
subregion.  Configuring Postgres in-Docker runs 7-14% faster than the default
Postgres in-Docker configuration.</p>
<pre><code class="language-bash">docker run --name pgosm -d --rm \
    -v ~/pgosm-data:/app/output \
    -v /etc/localtime:/etc/localtime:ro \
    -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
    -p 5433:5432 -d rustprooflabs/pgosm-flex \
    -c shared_buffers=512MB \
    -c work_mem=50MB \
    -c maintenance_work_mem=4GB \
    -c checkpoint_timeout=300min \
    -c max_wal_senders=0 -c wal_level=minimal \
    -c max_wal_size=10GB \
    -c checkpoint_completion_target=0.9 \
    -c random_page_cost=1.0
</code></pre>
<p>The <code>docker exec</code> command used for the timings.</p>
<pre><code class="language-bash">time docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=colorado \
    --layerset=basic \
    --pgosm-date=2021-10-08
</code></pre>
<h2 id="monitoring-the-import"><a class="header" href="#monitoring-the-import">Monitoring the import</a></h2>
<p>You can track the query activity in the database being loaded using the
<code>pg_stat_activity</code> view from <code>pg_catalog</code>.  Database connections use
<code>application_name = 'pgosm_flex'</code>.</p>
<pre><code class="language-sql">SELECT *
    FROM pg_catalog.pg_stat_activity
    WHERE application_name = 'pgosm-flex'
;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-files"><a class="header" href="#data-files">Data Files</a></h1>
<p>PgOSM Fle will automatically manage downloads of the appropriate data and <code>.md5</code>
files from the <a href="https://download.geofabrik.de/">Geofabrik download server</a>.
When using the default behavior, PgOSM Flex will automatically start downloading
the two necessary files:</p>
<ul>
<li><code>&lt;region/subregion&gt;-latest.osm.pbf</code></li>
<li><code>&lt;region/subregion&gt;-latest.osm.pbf.md5</code></li>
</ul>
<p>The data path on the host machine is defined via the <code>docker run</code> command. This
documentation always uses <code>~/pgosm-data</code> per the <a href="quick-start.html">quick start</a>.</p>
<pre><code class="language-bash">docker run --name pgosm -d --rm \
    -v ~/pgosm-data:/app/output \
    ...
</code></pre>
<blockquote>
<p>See the <a href="common-customization.html#selecting-region-and-subregion">Selecting Region and Sub-region</a>
section for more about the default behavior.</p>
</blockquote>
<p>There are two methods to override this default behavior: specify <code>--pgosm-date</code>
or use <code>--input-file</code>.
If you have manually saved files in the path used by PgOSM Flex using <code>-latest</code>
in the filename, they <strong>will be overwritten</strong> if you are not using one of the
methods described below.</p>
<h2 id="specific-date-with---pgosm-date"><a class="header" href="#specific-date-with---pgosm-date">Specific date with <code>--pgosm-date</code></a></h2>
<p>Use <code>--pgosm-date</code> to specify a specific date for the data.  The date specified
must be in <code>yyyy-mm-dd</code> format.
This mode requires you have a valid <code>.pbf</code> and matching <code>.md5</code> file in order to
function. The following example shows the <code>docker exec</code> command along with
a <code>--pgosm-date</code> defined.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia \
    --pgosm-date=2024-05-14
</code></pre>
<p>The output from running should confirm it finds and uses the file with the
specified date.
Remember, the paths reported from Docker (<code>/app/output/</code>) report the
container-internal path, not your local path on the host.</p>
<pre><code class="language-bash">INFO:pgosm-flex:geofabrik:PBF File exists /app/output/district-of-columbia-2024-05-14.osm.pbf
INFO:pgosm-flex:geofabrik:PBF &amp; MD5 files exist.  Download not needed
INFO:pgosm-flex:geofabrik:Copying Archived files
INFO:pgosm-flex:pgosm_flex:Running osm2pgsql
</code></pre>
<p>If a date is specified without matching file(s) it will raise an error and exit.</p>
<pre><code class="language-bash">ERROR:pgosm-flex:geofabrik:Missing PBF file for 2024-05-15. Cannot proceed.
</code></pre>
<h2 id="specific-input-file-with---input-file"><a class="header" href="#specific-input-file-with---input-file">Specific input file with <code>--input-file</code></a></h2>
<p>The automatic Geofabrik download can be overridden by providing PgOSM Flex
with the path to a valid <code>.osm.pbf</code> file using <code>--input-file</code>.
This option overrides the default file handling, archiving, and MD5
checksum validation.  With <code>--input-file</code> you can use a custom <code>osm.pbf</code>
you created, or use it to simply remove the need for an internet connection
from the instance running the processing.</p>
<blockquote>
<p>Note: The <code>--region</code> option is always required, the <code>--subregion</code> option can be used with <code>--input-file</code> to put the information in the <code>subregion</code> column of <code>osm.pgosm_flex</code>.</p>
</blockquote>
<h3 id="small-area--custom-extract"><a class="header" href="#small-area--custom-extract">Small area / custom extract</a></h3>
<p>Some of the smallest subregions provided by Geofabrik are quite large compared
to the area of interest for a project.
The <code>osmium</code> tool makes it quick and easy to
<a href="https://docs.osmcode.org/osmium/latest/osmium-extract.html">extract a bounding box</a>.
The following example extracts an area roughly around Denver, Colorado.
It takes about 3 seconds to extract the 3.2 MB <code>denver.osm.pbf</code> output from
the 239 MB input.</p>
<pre><code class="language-bash">osmium extract --bbox=-105.0193,39.7663,-104.9687,39.7323 \
    -o denver.osm.pbf \
    colorado-2023-04-18.osm.pbf
</code></pre>
<p>The PgOSM Flex processing time for the smaller Denver region takes less than 20 seconds on a
typical laptop, versus 11 minutes for all of Colorado.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=custom \
    --subregion=denver \
    --input-file=denver.osm.pbf \
    --layerset=everything
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="querying-with-pgosm-flex"><a class="header" href="#querying-with-pgosm-flex">Querying with PgOSM Flex</a></h1>
<h2 id="nested-admin-polygons"><a class="header" href="#nested-admin-polygons">Nested admin polygons</a></h2>
<p>Nested admin polygons are stored in the table <code>osm.place_polygon_nested</code>.
The <code>osm.build_nested_admin_polygons()</code> to populate the table is defined in <code>flex-config/place.sql</code>,
the Docker process automatically runs it.
Can run quickly on small areas (Colorado), takes significantly longer on larger
areas (North America).</p>
<p>The Python script in the Docker image has a <code>--skip-nested</code> option to skip
running the function to populate the table.  It can always be populated
at a later time manually using the function.</p>
<pre><code class="language-sql">CALL osm.build_nested_admin_polygons();
</code></pre>
<p>When this process is running for a while it can be monitored with this query.</p>
<pre><code class="language-sql">SELECT COUNT(*) AS row_count,
        COUNT(*) FILTER (WHERE nest_level IS NOT NULL) AS rows_processed
    FROM osm.place_polygon_nested
;
</code></pre>
<h1 id="quality-control-queries"><a class="header" href="#quality-control-queries">Quality Control Queries</a></h1>
<h2 id="features-not-loaded"><a class="header" href="#features-not-loaded">Features not Loaded</a></h2>
<p>The process of selectively load specific features and not others always has the chance
of accidentally missing important data.</p>
<p>Running and examine tags from the SQL script <code>db/qc/features_not_in_run_all.sql</code>.
Run within <code>psql</code> (using <code>\i db/qc/features_not_in_run_all.sql</code>) or a GUI client
to explore the temp table used to return the aggregated results, <code>osm_missing</code>.
The table is a <code>TEMP TABLE</code> so will disappear when the session ends.</p>
<p>Example results from initial run (v0.0.4) showed some obvious omissions from the
current layer definitions.</p>
<pre><code class="language-bash">┌────────────────────────────────────────┬────────┐
│           jsonb_object_keys            │ count  │
╞════════════════════════════════════════╪════════╡
│ landuse                                │ 110965 │
│ addr:street                            │  89482 │
│ addr:housenumber                       │  89210 │
│ name                                   │  47151 │
│ leisure                                │  25351 │
│ addr:state                             │  19051 │
│ power                                  │  16933 │
│ addr:unit                              │  13973 │
│ building:part                          │  13773 │
│ golf                                   │  13427 │
│ railway                                │  13032 │
│ addr:city                              │  12426 │
│ addr:postcode                          │  12358 │
│ height                                 │  12113 │
│ building:colour                        │  11124 │
│ roof:colour                            │  11115 │
</code></pre>
<h2 id="unroutable-routes"><a class="header" href="#unroutable-routes">Unroutable routes</a></h2>
<p>The <code>helpers.lua</code> methods are probably not perfect.</p>
<ul>
<li><code>routable_foot()</code></li>
<li><code>routable_cycle()</code></li>
<li><code>routable_motor()</code></li>
</ul>
<pre><code class="language-sql">SELECT * FROM osm.road_line
    WHERE NOT route_foot AND NOT route_motor AND NOT route_cycle
;
</code></pre>
<blockquote>
<p>Not all rows returned are errors.  <code>highway = 'construction'</code> is not necessarily determinate...</p>
</blockquote>
<h2 id="relations-missing-from-unitable"><a class="header" href="#relations-missing-from-unitable">Relations missing from unitable</a></h2>
<pre><code class="language-sql">SELECT t.*
    FROM osm.tags t
    WHERE t.geom_type = 'R' 
        AND NOT EXISTS (
            SELECT 1
            FROM osm.unitable u
            WHERE u.geom_type = t.geom_type AND t.osm_id = u.osm_id
);
</code></pre>
<h2 id="points-of-interest-pois"><a class="header" href="#points-of-interest-pois">Points of Interest (POIs)</a></h2>
<p>PgOSM Flex loads an range of tags into a materialized view (<code>osm.poi_all</code>) for
easily searching POIs.
Line and polygon data is forced to point geometry using
<code>ST_Centroid()</code>.  This layer duplicates a bunch of other more specific layers
(shop, amenity, etc.) to provide a single place for simplified POI searches.</p>
<p>Special layer included by layer sets <code>run-all</code> and <code>run-no-tags</code>.
See <code>style/poi.lua</code> for logic on how to include POIs.
The topic of POIs is subject and likely is not inclusive of everything that probably should be considered
a POI. If there are POIs missing
from this table please submit a <a href="https://github.com/rustprooflabs/pgosm-flex/issues/new">new issue</a>
with sufficient details about what is missing.
Pull requests also welcome! See <a href="contributing.html">the contributing section</a>
for more information.</p>
<p>Counts of POIs by <code>osm_type</code>.</p>
<pre><code class="language-sql">SELECT osm_type, COUNT(*)
    FROM osm.vpoi_all
    GROUP BY osm_type
    ORDER BY COUNT(*) DESC;
</code></pre>
<p>Results from Washington D.C. subregion (March 2020).</p>
<pre><code>┌──────────┬───────┐
│ osm_type │ count │
╞══════════╪═══════╡
│ amenity  │ 12663 │
│ leisure  │  2701 │
│ building │  2045 │
│ shop     │  1739 │
│ tourism  │   729 │
│ man_made │   570 │
│ landuse  │    32 │
│ natural  │    19 │
└──────────┴───────┘
</code></pre>
<p>Includes Points (<code>N</code>), Lines (<code>L</code>) and Polygons (<code>W</code>).</p>
<pre><code class="language-sql">SELECT geom_type, COUNT(*) 
    FROM osm.vpoi_all
    GROUP BY geom_type
    ORDER BY COUNT(*) DESC;
</code></pre>
<pre><code>┌───────────┬───────┐
│ geom_type │ count │
╞═══════════╪═══════╡
│ W         │ 10740 │
│ N         │  9556 │
│ L         │   202 │
└───────────┴───────┘
</code></pre>
<h2 id="meta-table-1"><a class="header" href="#meta-table-1">Meta table</a></h2>
<p>PgOSM Flex tracks processing metadata in the <code>osm.pgosm_flex</code>  table. The initial import
has <code>osm2pgsql_mode = 'create'</code>, the subsequent update has
<code>osm2pgsql_mode = 'append'</code>.</p>
<pre><code class="language-sql">SELECT osm_date, region, srid,
        pgosm_flex_version, osm2pgsql_version, osm2pgsql_mode
    FROM osm.pgosm_flex
;
</code></pre>
<pre><code class="language-bash">┌────────────┬───────────────────────────┬──────┬────────────────────┬───────────────────┬────────────────┐
│  osm_date  │          region           │ srid │ pgosm_flex_version │ osm2pgsql_version │ osm2pgsql_mode │
╞════════════╪═══════════════════════════╪══════╪════════════════════╪═══════════════════╪════════════════╡
│ 2022-11-04 │ north-america/us-colorado │ 3857 │ 0.6.2-e1f140f      │ 1.7.2             │ create         │
│ 2022-11-25 │ north-america/us-colorado │ 3857 │ 0.6.2-e1f140f      │ 1.7.2             │ append         │
└────────────┴───────────────────────────┴──────┴────────────────────┴───────────────────┴────────────────┘
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="routing-with-pgosm-flex"><a class="header" href="#routing-with-pgosm-flex">Routing with PgOSM Flex</a></h1>
<p>This page provides a simple example of using OpenStreetMap roads
loaded with PgOSM Flex for routing.
The example uses the D.C. PBF included under <code>tests/data/</code>.
This specific data source is chosen to provide a consistent input
for predictable results.  Even with using the same data and the
same code, some steps will have minor differences. These differences
are mentioned in those sections.</p>
<pre><code class="language-bash">cd ~/pgosm-data

wget https://github.com/rustprooflabs/pgosm-flex/raw/main/tests/data/district-of-columbia-2021-01-13.osm.pbf
wget https://github.com/rustprooflabs/pgosm-flex/raw/main/tests/data/district-of-columbia-2021-01-13.osm.pbf.md5
</code></pre>
<p>Run <code>docker exec</code> to load the District of Columbia file from
January 13, 2021.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia \
    --pgosm-date=2021-01-13
</code></pre>
<h2 id="prepare-for-routing"><a class="header" href="#prepare-for-routing">Prepare for routing</a></h2>
<p>Create the <code>pgrouting</code> extension if it does not already exist.
Also create the <code>routing</code> schema to store the data used in this
example.</p>
<pre><code class="language-sql">CREATE EXTENSION IF NOT EXISTS pgrouting;
CREATE SCHEMA IF NOT EXISTS routing;
</code></pre>
<h3 id="clean-the-data"><a class="header" href="#clean-the-data">Clean the data</a></h3>
<p>Prepare roads for routing using `pgrouting`` functions.  The bulk of
the following code is removing multi-linestrings which cause errors
with pgRouting.</p>
<pre><code class="language-sql">CREATE TABLE routing.road_line AS
WITH a AS (
-- Remove as many multi-linestrings as possible with ST_LineMerge() 
SELECT osm_id, osm_type, maxspeed, oneway, layer,
        route_foot, route_cycle, route_motor, access,
        ST_LineMerge(geom) AS geom
    FROM osm.road_line
), extra_cleanup AS (
-- Pull out those that are still multi, use ST_Dump() to pull out parts
SELECT osm_id, osm_type, maxspeed, oneway, layer,
        route_foot, route_cycle, route_motor, access,
        (ST_Dump(geom)).geom AS geom
    FROM a 
    WHERE ST_GeometryType(geom) = 'ST_MultiLineString'
), combined AS (
-- Combine two sources
SELECT osm_id, osm_type, maxspeed, oneway, layer,
        route_foot, route_cycle, route_motor, access,
        geom
    FROM a
    WHERE ST_GeometryType(geom) != 'ST_MultiLineString'
UNION
SELECT osm_id, osm_type, maxspeed, oneway, layer,
        route_foot, route_cycle, route_motor, access,
        geom
    FROM extra_cleanup
    -- Some data may be lost here if multi-linestring somehow
    -- persists through the extra_cleanup query
    WHERE ST_GeometryType(geom) != 'ST_MultiLineString'
)
-- Calculate a new surrogate ID for key
SELECT ROW_NUMBER() OVER (ORDER BY geom) AS id, *
    FROM combined
    ORDER BY geom
;
</code></pre>
<p>The above query creates the <code>routing.road_line</code> table.  The next step
adds some database best practices to the table:</p>
<ul>
<li>Explain why a surrogate ID was added</li>
<li>Primary key on the <code>id</code> column</li>
<li>Index on <code>osm_id</code></li>
</ul>
<pre><code class="language-sql">COMMENT ON COLUMN routing.road_line.id IS 'Surrogate ID, cannot rely on osm_id being unique after converting multi-linestrings to linestrings.';
ALTER TABLE routing.road_line
    ADD CONSTRAINT pk_routing_road_line PRIMARY KEY (id)
;
CREATE INDEX ix_routing_road_line_osm_id
    ON routing.road_line (osm_id)
;
</code></pre>
<h3 id="run-pgrouting-functions"><a class="header" href="#run-pgrouting-functions">Run pgRouting functions</a></h3>
<p>To prepare the OpenStreetMap roads data for routing, run the
pgRouting functions <code>pgr_nodeNetwork()</code>, <code>pgr_createTopology()</code>,
and <code>pgr_analyzeGraph()</code>.</p>
<pre><code class="language-sql">SELECT pgr_nodeNetwork('routing.road_line', 0.1, 'id', 'geom');
SELECT pgr_createTopology('routing.road_line_noded', 0.1, 'geom');
SELECT pgr_analyzeGraph('routing.road_line_noded', 0.1, 'geom');
</code></pre>
<p>Running the functions shown above will create two (2) new tables
usable for routing.</p>
<ul>
<li><code>routing.road_line_noded</code></li>
<li><code>routing.road_line_noded_vertices_pgr</code></li>
</ul>
<h3 id="timing-note"><a class="header" href="#timing-note">Timing note</a></h3>
<p>The pgRouting functions shown in the preceding section can take a
long time to complete on larger regions.
It is often a good idea to run these from <code>psql</code> within a screen
emulator, such as <code>screen</code> or <code>tmux</code> that allow you to disconnect
from the long-running command without cancelling the query.</p>
<h3 id="determine-costs"><a class="header" href="#determine-costs">Determine Costs</a></h3>
<p>Routing requires a cost in order to determine the best route to
take.
The following query creates a simple <code>cost_length</code> column to
the <code>routing.road_line_noded</code> table as a generated column.
This is a simple way to get started with costs for routing.</p>
<pre><code class="language-sql">ALTER TABLE routing.road_line_noded
    ADD cost_length DOUBLE PRECISION NOT NULL
    GENERATED ALWAYS AS (ST_Length(geom))
    STORED; 
</code></pre>
<blockquote>
<p>Note: This is for non-directional routing.  See the <em>Routing <code>oneway</code></em> section below for more on directional routing.</p>
</blockquote>
<h2 id="determine-route-start-and-end"><a class="header" href="#determine-route-start-and-end">Determine route start and end</a></h2>
<p>The following query identifies the vertex IDs for a start and end point
to use for later queries. The query uses an input set of points
created from specific longitude/latitude values.
Use the <code>start_id</code> and <code>end_id</code> values from this query
in subsequent queries through the <code>:start_id</code> and <code>:end_id</code> variables
via DBeaver.</p>
<pre><code class="language-sql">WITH s_point AS (
SELECT v.id AS start_id
    FROM routing.road_line_noded_vertices_pgr v
    INNER JOIN (SELECT
        ST_Transform(ST_SetSRID(ST_MakePoint(-77.0211, 38.92255), 4326), 3857)
            AS geom
        ) p ON v.the_geom &lt;-&gt; geom &lt; 10
    ORDER BY v.the_geom &lt;-&gt; geom
    LIMIT 1
), e_point AS (
SELECT v.id AS end_id
    FROM routing.road_line_noded_vertices_pgr v
    INNER JOIN (SELECT
        ST_Transform(ST_SetSRID(ST_MakePoint(-77.0183, 38.9227), 4326), 3857)
            AS geom
        ) p ON v.the_geom &lt;-&gt; geom &lt; 10
    ORDER BY v.the_geom &lt;-&gt; geom
    LIMIT 1
)
SELECT s_point.start_id, e_point.end_id
    FROM s_point, e_point
;
</code></pre>
<pre><code class="language-bash">┌──────────┬────────┐
│ start_id │ end_id │
╞══════════╪════════╡
│    14630 │  14686 │
└──────────┴────────┘
</code></pre>
<blockquote>
<p>Warning: The vertex IDs returned by the above query will vary. The pgRouting functions that generate this data do not guarantee data will always be generated in precisely the same order, causing these IDs to be different.</p>
</blockquote>
<p>The vertex IDs returned were <code>14630</code> and <code>14686</code>.  These points
span a particular segment of road (<code>osm_id = 6062791</code>) that is tagged
as <code>highway=residential</code> and <code>access=private</code>.
This segment is used to illustrate how the calculated access
control columns, <code>route_motor</code>, <code>route_cycle</code> and <code>route_foot</code>,
can influence route selection.</p>
<pre><code class="language-sql">SELECT *
    FROM routing.road_line
    WHERE osm_id = 6062791
;
</code></pre>
<p><img src="dc-example-route-start-end-vertices.png" alt="Screenshot from QGIS showing two labeled points, 14630 and 14686. The road between the two points is shown with a light gray dash indicating the access tag indicates non-public travel." /></p>
<blockquote>
<p>See <code>flex-config/helpers.lua</code> functions (e.g. <code>routable_motor()</code>) for logic behind access control columns.</p>
</blockquote>
<h2 id="simple-route"><a class="header" href="#simple-route">Simple route</a></h2>
<p>Using <code>pgr_dijkstra()</code> and no additional filters will
use all roads from OpenStreetMap without regard to mode of travel
or access rules.
This query picks a route that traverses sidewalks and
a section of road with the
<a href="https://wiki.openstreetmap.org/wiki/Tag:access%3Dprivate"><code>access=private</code> tag from OpenStreetMap</a>.
The key details to focus on in the following queries
is the string containing a SQL query passed into the <code>pgr_dijkstra()</code>
function.  This first example is a simple query from the
<code>routing.road_line_noded</code> table.</p>
<blockquote>
<p>Note:  These queries are intended to be ran using DBeaver.  The <code>:start_id</code> and <code>:end_id</code> variables work within DBeaver, but not via <code>psql</code> or QGIS.  Support in other GUIs is unknown at this time (PRs welcome!).</p>
</blockquote>
<pre><code class="language-sql">SELECT d.*, n.the_geom AS node_geom, e.geom AS edge_geom
    FROM pgr_dijkstra(
        'SELECT id, source, target, cost_length AS cost,
                geom
            FROM routing.road_line_noded
            ',
            :start_id, :end_id, directed := False
        ) d
    INNER JOIN routing.road_line_noded_vertices_pgr n ON d.node = n.id
    LEFT JOIN routing.road_line_noded e ON d.edge = e.id
;
</code></pre>
<p><img src="dc-example-route-start-no-access-control.png" alt="Screenshot from DBeaver showing the route generated with all roads and no access control. The route is direct, traversing the road marked access=private." /></p>
<h2 id="route-motorized"><a class="header" href="#route-motorized">Route motorized</a></h2>
<p>The following query modifies the query passed in to <code>pgr_dijkstra()</code>
to join the <code>routing.road_line_noded</code> table to the
<code>routing.road_line</code> table.  This allows using attributes available
in the upstream table for additional routing logic.
The join clause includes a filter on the <code>route_motor</code> column.</p>
<p>From the comment on the <code>osm.road_line.route_motor</code> column:</p>
<blockquote>
<p>"Best guess if the segment is route-able for motorized traffic. If access is no or private, set to false. WARNING: This does not indicate that this method of travel is safe OR allowed!"</p>
</blockquote>
<p>Based on this comment, we can expect that adding <code>AND r.route_motor</code>
into the filter will ensure the road type is suitable for motorized
traffic, and it excludes routes marked private.</p>
<pre><code class="language-sql">SELECT d.*, n.the_geom AS node_geom, e.geom AS edge_geom
    FROM pgr_dijkstra(
        'SELECT n.id, n.source, n.target, n.cost_length AS cost,
                n.geom
            FROM routing.road_line_noded n
            INNER JOIN routing.road_line r ON n.old_id = r.id
                    AND r.route_motor
            ',
            :start_id, :end_id, directed := False
        ) d
    INNER JOIN routing.road_line_noded_vertices_pgr n ON d.node = n.id
    LEFT JOIN routing.road_line_noded e ON d.edge = e.id
;
</code></pre>
<p><img src="dc-example-route-start-motor-access-control.png" alt="Screenshot from DBeaver showing the route generated with all roads and limiting based on route_motor. The route bypasses the road(s) marked access=no and access=private." /></p>
<h2 id="route-oneway"><a class="header" href="#route-oneway">Route <code>oneway</code></a></h2>
<p>The route shown in the previous example now respects the
access control and limits to routes suitable for motorized traffic.
It, however, <strong>did not</strong> respect the one-way access control.
The very first segment (top-left corner of screenshot) went
the wrong way on a one-way street.
This behavior is a result of the simple length-based cost model.</p>
<p>The <code>oneway</code> column in the road tables uses
<a href="https://osm2pgsql.org/doc/manual.html#type-conversions">osm2pgsql's <code>direction</code> data type</a> which resolves to <code>int2</code> in Postgres.
Valid values are:</p>
<ul>
<li><code>0</code>: Not one way</li>
<li><code>1</code>: One way, forward travel allowed</li>
<li><code>-1</code>: One way, reverse travel allowed</li>
<li><code>NULL</code>: It's complicated. See #172.</li>
</ul>
<p>Assuming a noded roads table routing table, bring over the <code>oneway</code> detail</p>
<pre><code class="language-sql">ALTER TABLE routing.road_line_noded
    ADD oneway INT2 NULL
;

UPDATE routing.road_line_noded rn
    SET oneway = r.oneway
    FROM routing.road_line r
    WHERE rn.old_id = r.id AND rn.oneway IS NULL
;
</code></pre>
<h3 id="forward-and-reverse-costs"><a class="header" href="#forward-and-reverse-costs">Forward and reverse costs</a></h3>
<p>Calculate forward cost.</p>
<pre><code class="language-sql">ALTER TABLE routing.road_line_noded
    DROP COLUMN IF EXISTS cost_length
;

-- Cost with oneway considerations
ALTER TABLE routing.road_line_noded
    ADD cost_length NUMERIC
    GENERATED ALWAYS AS (
        CASE WHEN oneway IN (0, 1) OR oneway IS NULL
                THEN ST_Length(geom)
            WHEN oneway = -1
                THEN -1 * ST_Length(geom)
            END
    )
    STORED
;
</code></pre>
<p>Reverse cost.</p>
<pre><code class="language-sql">-- Reverse cost with oneway considerations
ALTER TABLE routing.road_line_noded
    ADD cost_length_reverse NUMERIC
    GENERATED ALWAYS AS (
        CASE WHEN oneway IN (0, -1) OR oneway IS NULL
                THEN ST_Length(geom)
            WHEN oneway = 1
                THEN -1 * ST_Length(geom)
            END
    )
    STORED
;
</code></pre>
<p>This query uses the new reverse cost colum, and changes
<code>directed</code> from <code>False</code> to <code>True</code>.</p>
<pre><code class="language-sql">SELECT d.*, n.the_geom AS node_geom, e.geom AS edge_geom
    FROM pgr_dijkstra(
        'SELECT n.id, n.source, n.target, n.cost_length AS cost,
                n.cost_length_reverse AS reverse_cost,
                n.geom
            FROM routing.road_line_noded n
            INNER JOIN routing.road_line r ON n.old_id = r.id
                    AND r.route_motor
            ',
            :start_id, :end_id, directed := True
        ) d
    INNER JOIN routing.road_line_noded_vertices_pgr n ON d.node = n.id
    LEFT JOIN routing.road_line_noded e ON d.edge = e.id
;
</code></pre>
<p><img src="dc-example-route-start-motor-access-control-oneway.png" alt="Screenshot from DBeaver showing the route generated with all roads and limiting based on route_motor and using the improved cost model including forward and reverse costs. The route bypasses the road(s) marked access=no and access=private, as well as respects the one-way access controls." /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="processing-time"><a class="header" href="#processing-time">Processing Time</a></h1>
<p>The purpose of this page is to provide a rough guideline of what to
expect for how long PgOSM Flex processing will take.
Two server sizes are used for this testing hosted by Digital Ocean.
The larger size server
has 8 vCPU and 64 GB RAM to match the target
server size <a href="https://osm2pgsql.org/doc/manual.html#preparing-the-database">outlined in the osm2pgsql manual</a>. The current matching Digital Ocean
resource class is the Memory-Optimized with dedicated CPU resources.
This comes with a 200 GB SSD. The cost for this class of instance
is $0.500 / hour, or $336 / month.  A good number of production Postgres
instances can run on this hardware.</p>
<p>The smaller server size is a budget friendly 2 AMD vCPU and 2 GB RAM
on shared CPU resources. The cost for this class of instance is
$0.031 / hour, or $21 / month.</p>
<h2 id="versions-tested"><a class="header" href="#versions-tested">Versions Tested</a></h2>
<p>Versions used for testing: PgOSM Flex 0.7.1 Docker image, based on the official
PostGIS image with Postgres 15.2 / PostGIS 3.3.  osm2pgsql 1.8.1.</p>
<p>Note: Postgres 15 <a href="https://osm2pgsql.org/news/2023/01/22/faster-with-postgresql15.html">made GIST indexes faster</a>
to create.  Using an version prior to Postgres 14 will likely take longer.</p>
<h2 id="methodology"><a class="header" href="#methodology">Methodology</a></h2>
<p>Create instance, Ubuntu 22.04.</p>
<pre><code class="language-bash">sudo apt update \
    &amp;&amp; sudo apt upgrade -y \
    &amp;&amp; sudo apt autoremove -y \
    &amp;&amp; sudo apt install -y apt-transport-https ca-certificates curl software-properties-common \
    &amp;&amp; curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \
    &amp;&amp; echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null \
    &amp;&amp; sudo apt update \
    &amp;&amp; sudo apt install docker-ce \
    &amp;&amp; sudo reboot -h now
</code></pre>
<p>The timing for the first <code>docker exec</code> for each region was discarded as
it included the timing for downloading the PBF file.</p>
<p>Timings are an average of multiple recorded test runs over more than one day.
For example, the Norway region for the <code>minimal</code> layerset had two times: 5 min 35 seconds
and 5 minutes 37 seconds for an average of 5 minutes 36 seconds.</p>
<p>Time for the import step is reported using the Linux <code>time</code> command on the <code>docker exec</code>
step as shown in the following commands.</p>
<p><code>PostGIS Size</code> reported is according to the meta-data in Postgres using this query.</p>
<pre><code class="language-sql">SELECT d.oid, d.datname AS db_name,
        pg_size_pretty(pg_database_size(d.datname)) AS db_size
    FROM pg_catalog.pg_database d
    WHERE d.datname = current_database()
</code></pre>
<h3 id="commands"><a class="header" href="#commands">Commands</a></h3>
<p>Set environment variables and start <code>pgosm</code> Docker container with configurations
set per the <a href="https://osm2pgsql.org/doc/manual.html#tuning-the-postgresql-server">osm2pgsql tuning guidelines</a>.</p>
<pre><code class="language-bash">export POSTGRES_USER=postgres
export POSTGRES_PASSWORD=mysecretpassword

docker run --name pgosm -d --rm \
    -v ~/pgosm-data:/app/output \
    -v /etc/localtime:/etc/localtime:ro \
    -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
    -p 5433:5432 -d rustprooflabs/pgosm-flex:0.7.1 \
    -c shared_buffers=1GB \
    -c work_mem=50MB \
    -c maintenance_work_mem=10GB \
    -c autovacuum_work_mem=2GB \
    -c checkpoint_timeout=300min \
    -c max_wal_senders=0 -c wal_level=minimal \
    -c max_wal_size=10GB \
    -c checkpoint_completion_target=0.9 \
    -c random_page_cost=1.0 \
    -c full_page_writes=off \
    -c fsync=off
</code></pre>
<blockquote>
<p>WARNING:  Setting <code>full_page_writes=off</code> and <code>fsync=off</code> is part of the <a href="https://osm2pgsql.org/doc/manual.html#expert-tuning">expert tuning</a> for the best possible performance.  This is deemed acceptable in this Docker container running <code>--rm</code>, obviously this container will be discarded immediately after processing. <strong>DO NOT</strong> use these configurations unless you understand and accept the risks of corruption.</p>
</blockquote>
<p>Run PgOSM Flex within Docker.  The first run time is discarded because the first
run time includes time downloading the PBF file.  Subsequent runs only include the
time running the processing.</p>
<pre><code class="language-bash">
time docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=64 \
    --region=north-america/us \
    --subregion=colorado \
    --layerset=minimal
</code></pre>
<h2 id="layerset--minimal"><a class="header" href="#layerset--minimal">Layerset:  Minimal</a></h2>
<p>The <code>minimal</code> layer set only loads major roads, places, and POIs.</p>
<p>Timings with nested admin polygons and dumping the processed data to a <code>.sql</code>
file.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Sub-region</th><th style="text-align: center">PBF Size</th><th style="text-align: center">PostGIS Size</th><th style="text-align: center"><code>.sql</code> Size</th><th style="text-align: center">Import Time</th></tr></thead><tbody>
<tr><td style="text-align: left">District of Columbia</td><td style="text-align: center">18 MB</td><td style="text-align: center">36 MB</td><td style="text-align: center">14 MB</td><td style="text-align: center">15.3 sec</td></tr>
<tr><td style="text-align: left">Colorado</td><td style="text-align: center">226 MB</td><td style="text-align: center">181 MB</td><td style="text-align: center">129 MB</td><td style="text-align: center">1 min 23 sec</td></tr>
<tr><td style="text-align: left">Norway</td><td style="text-align: center">1.1 GB</td><td style="text-align: center">618 MB</td><td style="text-align: center">489 MB</td><td style="text-align: center">5 min 36 sec</td></tr>
<tr><td style="text-align: left">North America</td><td style="text-align: center">12 GB</td><td style="text-align: center">9.5 GB</td><td style="text-align: center">7.7 GB</td><td style="text-align: center">3.03 hours</td></tr>
</tbody></table>
</div>
<p>Timings skipping nested admin polygons the dump to <code>.sql</code>.  This adds
<code>--skip-dump --skip-nested</code> to the <code>docker exec process</code>. The following
table compares the import time using these skips against the full times reported
above.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Sub-region</th><th style="text-align: center">Import Time (full)</th><th style="text-align: center">Import Time (skips)</th></tr></thead><tbody>
<tr><td style="text-align: left">District of Columbia</td><td style="text-align: center">15.3 sec</td><td style="text-align: center">15.0 sec</td></tr>
<tr><td style="text-align: left">Colorado</td><td style="text-align: center">1 min 23 sec</td><td style="text-align: center">1 min 21 sec</td></tr>
<tr><td style="text-align: left">Norway</td><td style="text-align: center">5 min 36 sec</td><td style="text-align: center">5 min 12 sec</td></tr>
<tr><td style="text-align: left">North America</td><td style="text-align: center">3.03 hours</td><td style="text-align: center">1.25 hours</td></tr>
</tbody></table>
</div>
<h2 id="layerset--default"><a class="header" href="#layerset--default">Layerset:  Default</a></h2>
<p>The <code>default</code> layer set....</p>
<p>Timings with nested admin polygons and dumping the processed data to a <code>.sql</code>
file.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Sub-region</th><th style="text-align: center">PBF Size</th><th style="text-align: center">PostGIS Size</th><th style="text-align: center"><code>.sql</code> Size</th><th style="text-align: center">Import Time</th></tr></thead><tbody>
<tr><td style="text-align: left">District of Columbia</td><td style="text-align: center">18 MB</td><td style="text-align: center">212 MB</td><td style="text-align: center">160 MB</td><td style="text-align: center">53 sec</td></tr>
<tr><td style="text-align: left">Colorado</td><td style="text-align: center">226 MB</td><td style="text-align: center">2.1 GB</td><td style="text-align: center">1.9 GB</td><td style="text-align: center">8 min 20 sec</td></tr>
<tr><td style="text-align: left">Norway</td><td style="text-align: center">1.1 GB</td><td style="text-align: center">7.2 GB</td><td style="text-align: center">6.5 GB</td><td style="text-align: center">33 min 44 sec</td></tr>
<tr><td style="text-align: left">North America</td><td style="text-align: center">12 GB</td><td style="text-align: center">98 GB</td><td style="text-align: center">55 GB</td><td style="text-align: center">8.78 hours</td></tr>
</tbody></table>
</div>
<p>Timings skipping nested admin polygons the dump to <code>.sql</code>.  This adds
<code>--skip-dump --skip-nested</code> to the <code>docker exec process</code>. The following
table compares the import time using these skips against the full times reported
above.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Sub-region</th><th style="text-align: center">Import Time (full)</th><th style="text-align: center">Import Time (skips)</th></tr></thead><tbody>
<tr><td style="text-align: left">District of Columbia</td><td style="text-align: center">53 sec</td><td style="text-align: center">51 sec</td></tr>
<tr><td style="text-align: left">Colorado</td><td style="text-align: center">8 min 20 sec</td><td style="text-align: center">7 min 55 sec</td></tr>
<tr><td style="text-align: left">Norway</td><td style="text-align: center">33 min 44 sec</td><td style="text-align: center">32 min 18 sec</td></tr>
<tr><td style="text-align: left">North America</td><td style="text-align: center">8.78 hours</td><td style="text-align: center">6.58 hours</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="postgres-permissions-for-pgosm-flex"><a class="header" href="#postgres-permissions-for-pgosm-flex">Postgres permissions for PgOSM Flex</a></h1>
<p>The <a href="quick-start.html">quick start</a> section showed how to get up and
running using the Postgres instance within the PgOSM Flex docker image.
Many production usage cases of PgOSM Flex prefer to connect the
PgOSM Flex processing within Docker directly to an already running
Postgres instances.</p>
<p>The first step to using PgOSM Flex with your own Postgres instance
is to have a database already created, and a login role with
proper permissions.
The steps in this page prepare for the steps outlined
in the <a href="postgres-external.html">Using External Postgres Connection</a>
section.</p>
<h2 id="create-database-and-postgis"><a class="header" href="#create-database-and-postgis">Create database and PostGIS</a></h2>
<p>These first steps require elevated permissions within Postgres.
<code>CREATE DATABASE</code> requires the <code>CREATEDB</code> permission.
Creating the PostGIS extension requires
<a href="https://blog.rustprooflabs.com/2021/12/postgis-permissions-required">Postgres superuser permissions</a>.</p>
<p>In the target Postgres instance, create your database.</p>
<pre><code class="language-sql">CREATE DATABASE your_db_name;
</code></pre>
<p>Connect to <code>your_db_name</code> and create the PostGIS extension.
This is done along with the <code>CREATE DATABASE</code> since both steps
require the superuser role.</p>
<pre><code class="language-sql">CREATE EXTENSION postgis;
</code></pre>
<h2 id="runtime-permissions"><a class="header" href="#runtime-permissions">Runtime permissions</a></h2>
<p>Your target database needs to have an <code>osm</code> schema and the database user
requires the ability to create and populate tables in <code>osm</code>.</p>
<p>The following commands show one approach to granting permissions
required for PgOSM Flex to run on an external database.
Do not simply run this assuming this is the proper approach
for your database security!</p>
<pre><code class="language-sql">CREATE ROLE pgosm_flex WITH LOGIN PASSWORD 'mysecretpassword';
CREATE SCHEMA osm AUTHORIZATION pgosm_flex;
GRANT CREATE ON DATABASE your_db_name
    TO pgosm_flex;
GRANT CREATE ON SCHEMA public
    TO pgosm_flex;
</code></pre>
<p>These permissions should allow the full PgOSM Flex process to run.</p>
<p><code>GRANT CREATE ON DATABASE</code> is required to allow the sqitch process to run and create the <code>pgosm</code> schema.</p>
<p><code>GRANT CREATE ON SCHEMA public</code> is required for Postgres 15 and newer.</p>
<h2 id="reduced-permissions"><a class="header" href="#reduced-permissions">Reduced permissions</a></h2>
<p><code>GRANT CREATE</code> gives the <code>pgosm_flex</code> role far more permissions than
it really needs in many cases.
Running <code>docker exec</code> with <code>--data-only</code> skips these steps and would make the <code>GRANT CREATE</code> permission unnecessary for the <code>pgosm_flex</code> role.</p>
<p>It also is often desired to not make
a login role the owner of database objects. This example reduces the
scope of permissions.</p>
<pre><code class="language-sql">CREATE ROLE pgosm_flex;
CREATE SCHEMA osm AUTHORIZATION pgosm_flex;
GRANT pgosm_flex TO your_login_role;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-external-postgres-connection"><a class="header" href="#using-external-postgres-connection">Using External Postgres Connection</a></h1>
<p>Prepare the database and permissions as described in
<a href="postgres-permissions.html">Postgres Permissions</a>.</p>
<p>Set environment variables to define the connection.  Create a file with the
configuration options.</p>
<pre><code class="language-bash">touch ~/.pgosm-db-myproject
chmod 0700 ~/.pgosm-db-myproject
nano ~/.pgosm-db-myproject
</code></pre>
<p>Put in the contents specific to your database connection.</p>
<pre><code class="language-bash">export POSTGRES_USER=your_login_role
export POSTGRES_PASSWORD=mysecretpassword
export POSTGRES_HOST=your-host-or-ip
export POSTGRES_DB=your_db_name
export POSTGRES_PORT=5432
</code></pre>
<p>Env vars can be loaded using <code>source</code>.</p>
<pre><code class="language-bash">source ~/.pgosm-db-myproject
</code></pre>
<p>Run the container with the additional environment variables.</p>
<pre><code class="language-bash">docker run --name pgosm -d --rm \
    -v ~/pgosm-data:/app/output \
    -v /etc/localtime:/etc/localtime:ro \
    -e POSTGRES_USER=$POSTGRES_USER \
    -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
    -e POSTGRES_HOST=$POSTGRES_HOST \
    -e POSTGRES_DB=$POSTGRES_DB \
    -e POSTGRES_PORT=$POSTGRES_PORT \
    -p 5433:5432 -d rustprooflabs/pgosm-flex
</code></pre>
<p>The <code>docker exec</code> command is the same as when using the internal Postgres instance.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia
</code></pre>
<h2 id="notes"><a class="header" href="#notes">Notes</a></h2>
<p>The <code>POSTGRES_HOST</code> value is in relation to the Docker container.
Using <code>localhost</code> refers to the Docker container and will use the Postgres instance
within the Docker container, not your host running the Docker container.
Use <code>ip addr</code> to find your local host's IP address and provide that.</p>
<p>Setting <code>POSTGRES_HOST</code> to anything but <code>localhost</code> disables the drop/create database step. This means the target database must be created prior to running PgOSM Flex.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-updates"><a class="header" href="#data-updates">Data updates</a></h1>
<p>Keeping OpenStreetMap data recent and up-to-date is important to many projects.
However, this concept can mean very different things depending on the needs at
hand.</p>
<p>There are three (3) main ways to run subsequent imports using PgOSM Flex.</p>
<ul>
<li><a href="replication.html">Replication</a></li>
<li><a href="relocate-data.html">Relocate data</a></li>
<li><a href="update-mode.html">Manual Updates</a></li>
</ul>
<h2 id="replication"><a class="header" href="#replication">Replication</a></h2>
<p><a href="replication.html">Replication</a> should be the default first choice to consider.
Replication is best used when you only want to load one region of data and want
to keep the region's data recent.</p>
<p>Pros:</p>
<ul>
<li>Fast updates after the first import</li>
<li>Easy</li>
</ul>
<p>Cons:</p>
<ul>
<li>Increased database size</li>
<li>Little flexibility after initial import</li>
</ul>
<h2 id="relocate-data"><a class="header" href="#relocate-data">Relocate data</a></h2>
<p><a href="relocate-data.html">Relocating data</a> involves renaming the <code>osm</code> schema.
This allows PgOSM Flex to run in single-import mode, and to import any number
of different regions.</p>
<p>Pros:</p>
<ul>
<li>Simple</li>
<li>Smaller database size per region</li>
<li>Very customizable</li>
</ul>
<p>Cons:</p>
<ul>
<li>Always single-import</li>
<li>Duplicates a lot of data if using for snapshots over time on one region</li>
</ul>
<h2 id="manual-updates"><a class="header" href="#manual-updates">Manual Updates</a></h2>
<p><a href="update-mode.html">Manual Updates</a> provide significant flexibility with a tradeoff
in import performance</p>
<p>Pros:</p>
<ul>
<li>Very customizable</li>
</ul>
<p>Cons:</p>
<ul>
<li>Very slow updates</li>
<li>Poorly documented in PgOSM Flex</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-replication"><a class="header" href="#using-replication">Using Replication</a></h1>
<p>The <code>--replication</code> option of PgOSM Flex enables <code>osm2pgsql-replication</code>
to provide an easy and quick way to keep your OpenStreetMap data refreshed.</p>
<p>PgOSM Flex's <code>--replication</code> mode wraps around the <code>osm2pgsql-replication</code> package
included with <code>osm2pgsql</code>.  The first time running an import with <code>--replication</code>
mode runs osm2pgsql normally, with <code>--slim</code> mode and without <code>--drop</code>.
After osm2pgsql completes, <code>osm2pgsql-replication init ...</code> is ran to setup
the DB for updates.
This mode of operation results in larger database as the intermediate osm2pgsql
tables (<code>--slim</code>) must be left in the database (no <code>--drop</code>).</p>
<blockquote>
<p>Important:  The original <code>--append</code> option is now under <code>--replication</code>. The <code>--append</code> option was removed in PgOSM Flex 0.7.0.  See <a href="https://github.com/rustprooflabs/pgosm-flex/issues/275">#275</a> for context.</p>
</blockquote>
<h2 id="use-tagged-version"><a class="header" href="#use-tagged-version">Use tagged version</a></h2>
<p>When using replication you should pin your process to a specific PgOSM Flex version
in the <code>docker run</code> command.  When upgrading to new versions,
be sure to check the release notes for manual upgrade steps for <code>--replication</code>.<br />
The release notes for
<a href="https://github.com/rustprooflabs/pgosm-flex/releases/tag/0.6.1">PgOSM Flex 0.6.1</a>
are one example.
The notes discussed in the release notes have reference SQL scripts
under <code>db/data-migration</code> folder.</p>
<hr />
<p><strong>WARNING - Due to the ability to configure custom layersets these data-migration
scripts need manual review, and possibly manual adjustments for
your specific database and process.</strong></p>
<hr />
<h2 id="not-tested-by-make"><a class="header" href="#not-tested-by-make">Not tested by <code>make</code></a></h2>
<p>The function exposed by <code>--replication</code> is not tested via PgOSM's <code>Makefile</code>.</p>
<h2 id="max-connections"><a class="header" href="#max-connections">Max connections</a></h2>
<p>The other important change when using replication is to increase Postgres' <code>max_connections</code>.
See <a href="https://github.com/openstreetmap/osm2pgsql/discussions/1650">this discussion on osm2pgsql</a>
for why this is necessary.</p>
<p>If using the Docker-internal Postgres instance this is done with <code>-c max_connections=300</code>
in the <code>docker run</code> command.  External database connections must update this
in the appropriate <code>postgresql.conf</code> file.</p>
<pre><code class="language-bash">export POSTGRES_USER=postgres
export POSTGRES_PASSWORD=mysecretpassword

docker run --name pgosm -d --rm \
    -v ~/pgosm-data:/app/output \
    -v /etc/localtime:/etc/localtime:ro \
    -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
    -p 5433:5432 \
    -d rustprooflabs/pgosm-flex:0.10.0 \
        -c max_connections=300
</code></pre>
<h2 id="using---replication"><a class="header" href="#using---replication">Using <code>--replication</code></a></h2>
<p>Run the <code>docker exec</code> step with <code>--replication</code>.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia \
    --replication
</code></pre>
<p>Running the above command a second time will detect that the target database
has <code>osm2pgsql-replication</code> setup and load data via the defined replication
service.</p>
<h2 id="one-replication-source"><a class="header" href="#one-replication-source">One replication source</a></h2>
<p>Replication with PgOSM Flex is limited to one data source per database.
While it is possible to <a href="common-customization.html#schema-name">load multiple regions</a>,
each into their own schema
using <code>--schema-name</code>, replication via osm2pgsql-replication only supports
a single source.  See <a href="https://github.com/openstreetmap/osm2pgsql/pull/1769">this issue</a>
for details.  Possibly this ability will be supported in the future.</p>
<h2 id="resetting-replication"><a class="header" href="#resetting-replication">Resetting Replication</a></h2>
<blockquote>
<p>⚠️ WARNING! ⚠️ This section is <strong>only suitable for DEVELOPMENT databases</strong>.
Do NOT USE on production databases!</p>
</blockquote>
<p>Replication with PgOSM Flex <code>--replication</code> is simply a wrapper around the
<code>osm2pgsql-replication</code> tool. If you need to reload a <strong>development</strong>
database after using <code>--replication</code> you must remove the data from the
<code>public.osm2pgsql_properties</code> table.  If you do not remove this data,
PgOSM Flex will detect the replication setup and attempt to update data, not
load fresh.</p>
<pre><code class="language-sql">DELETE FROM public.osm2pgsql_properties;
</code></pre>
<blockquote>
<p>WARNING: This process works as an okay hack when you are using the same layerset
in the new import as was previously used.  If you use a layerset with fewer
tables, the original tables from the original layerset will persist and can
cause confusion about what was loaded.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="relocate-data-1"><a class="header" href="#relocate-data-1">Relocate Data</a></h1>
<p>This section describes how to relocate OpenStreetMap data loaded using PgOSM Flex.
These instructions apply to using an external Postgres database in single-import
mode.</p>
<blockquote>
<p>Do not use these instructions when using <code>--append</code>, <code>--update</code>, or <code>--replication</code>. Something will most likely break.</p>
</blockquote>
<h2 id="why-relocate-data"><a class="header" href="#why-relocate-data">Why relocate data</a></h2>
<p>There are two common reasons you may want to relocate data.  The same approach
works for both of these scenarios.</p>
<ul>
<li>Snapshots over time</li>
<li>Different regions</li>
</ul>
<p>If your goal is to have the latest data always available, consider using
<a href="replication.html">replication</a> instead.</p>
<h2 id="rename-schema"><a class="header" href="#rename-schema">Rename Schema</a></h2>
<p>PgOSM Flex always uses the <code>osm</code> schema.
The best way to relocate data is to simply rename the schema. This quickly moves
existing data out of the way for future PgOSM Flex use.  The following query
renames <code>osm</code> to <code>osm_2023_05</code>.</p>
<pre><code class="language-sql">ALTER SCHEMA osm RENAME TO osm_2023_05;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-update-mode"><a class="header" href="#using-update-mode">Using Update Mode</a></h1>
<p>Running with <code>--update</code> enables using osm2pgsql's <code>--append</code> option to load a second
input file. The PgOSM Flex functionality uses <code>--update create</code> and <code>--update append</code>.
See the discussion in <a href="https://github.com/rustprooflabs/pgosm-flex/issues/275">#275</a>
for more context behind the intent for this feature.</p>
<p>Using <code>--update append</code> requires the initial import used <code>--update create</code>. Attempting
to use <code>--update append</code> without first using <code>--update create</code> results in the error:
"ERROR: This database is not updatable. To create an updatable database use --slim (without --drop)."</p>
<p>If your goal is to easily refresh the data for a single, standard region/sub-region
you should investigate the <a href="/replication.html"><code>--replication</code> feature</a>. Using
replication is the easier and more efficient way to maintain data.</p>
<blockquote>
<p>Note: This is <strong>not</strong> the <code>--append</code> option that existed in PgOSM Flex 0.6.3 and prior.</p>
</blockquote>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<p>The following command uses <code>--update create</code> to load the <code>district-of-columbia</code>
sub-region. This example assumes you have set the environment variables and
have ran the docker container as shown in the <a href="quick-start.html">Quick Start</a> section.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia \
    --update create
</code></pre>
<p>The following loads a second sub-region (<code>maryland</code>) using <code>--update append</code>.</p>
<pre><code class="language-bash">time docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=maryland \
    --update append
</code></pre>
<h2 id="smaller-test"><a class="header" href="#smaller-test">Smaller test</a></h2>
<blockquote>
<p>This section has notes that probably belong elsewhere but I'm leaving them here for now.
They were initially helpful for testing the logic for this functionality.</p>
</blockquote>
<p>Put the following into <code>~/pgosm-data/extracts/colorado-extract.json</code>.</p>
<pre><code class="language-json">{
    "directory": "/home/ryanlambert/pgosm-data/",
    "extracts": [
        {
            "output": "colorado-boulder-latest.osm.pbf",
            "description": "Area extracted around Boulder, Colorado",
            "bbox": {
                "left": -105.30,
                "right": -105.20,
                "top": 40.07,
                "bottom": 39.98
            }
        },
        {
            "output": "colorado-longmont-latest.osm.pbf",
            "description": "Area extracted around Longmont, Colorado",
            "bbox": {
                "left": -105.15,
                "right": -105.05,
                "top": 40.21,
                "bottom": 40.12
            }
        }
    ]
}
</code></pre>
<p>Create Boulder and Longmont extracts using <code>osmium extract</code>.</p>
<pre><code class="language-bash">osmium extract -c extracts/colorado-extracts.json colorado-2022-12-27.osm.pbf
</code></pre>
<pre><code class="language-bash">ryanlambert@tag201:~/pgosm-data$ ls -alh | grep boulder
-rw-rw-r--  1 ryanlambert ryanlambert 2.4M Dec 27 14:31 colorado-boulder-latest.osm.pbf
ryanlambert@tag201:~/pgosm-data$ ls -alh | grep longmont
-rw-rw-r--  1 ryanlambert ryanlambert 988K Dec 27 14:31 colorado-longmont-latest.osm.pbf
</code></pre>
<p>Takes 11 seconds.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=colorado-longmont --input-file colorado-longmont-latest.osm.pbf \
    --update create
</code></pre>
<p>Takes 2 minutes.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=colorado-boulder --input-file colorado-boulder-latest.osm.pbf \
    --update append
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qgis-styles-for-pgosm-flex"><a class="header" href="#qgis-styles-for-pgosm-flex">QGIS Styles for PgOSM Flex</a></h1>
<p>If you use QGIS to visualize OpenStreetMap, there are a few basic
styles using the <code>public.layer_styles</code> table created by QGIS.
This data is loaded by default. Run PgOSM Flex with <code>--data-only</code> to skip loading
this data.</p>
<p>QGIS can save its styling information directly in a table in the Postgres database
using a table <code>public.layer_styles</code>.</p>
<pre><code class="language-sql">SELECT f_table_catalog, f_table_schema, f_table_name, stylename,
        useasdefault, description
    FROM public.layer_styles
;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="force-load"><a class="header" href="#force-load">Force Load</a></h1>
<blockquote>
<p>Added in PgOSM Flex 0.8.1.</p>
</blockquote>
<hr />
<h2 id="-danger-ahead-"><a class="header" href="#-danger-ahead-">⚠️ Danger ahead ⚠️</a></h2>
<p>The examples in this section can do bad things in production setups.
The <code>--force</code> feature exists for development use cases.</p>
<p><strong>Most users should consider moving old data out of the way using the methods
described in the <a href="./relocate-data.html">relocate data</a>.</strong></p>
<hr />
<h2 id="pgosm-flex-tries-to-be-safe"><a class="header" href="#pgosm-flex-tries-to-be-safe">PgOSM Flex <em>Tries</em> to be Safe</a></h2>
<p>PgOSM Flex <strong>attempts</strong> to avoid accidentally overwriting existing data
when using a database
<a href="./postgres-external.html">external to</a> the PgOSM Flex Docker container.
It does this by checking the data stored in the <code>osm.pgosm_flex</code> table.</p>
<blockquote>
<p>The <code>--force</code> feature only applies to external database connections. The internal database is always dropped and recreated when using the built-in database.</p>
</blockquote>
<p>This section assumes you have followed the instructions on the
<a href="./postgres-external.html">Postgres External section</a> including
<a href="postgres-permissions.html">setting up permissions</a>.
The protection against overwriting data is built into the <code>pgosm_flex.py</code> logic
ran via <code>docker exec</code>.  With PgOSM Flex 0.8.1 and later, running the following
command twice in a row will result in an</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia
</code></pre>
<p>Running the <code>docker exec</code> step a second time would result in
the following error.</p>
<pre><code class="language-bash">2023-05-29 08:08:19,495:ERROR:pgosm-flex:import_mode:Prior data exists in the osm schema and --force was not used.
2023-05-29 08:08:19,495:ERROR:pgosm-flex:pgosm_flex:Not okay to run PgOSM Flex. Exiting
</code></pre>
<h2 id="using---force"><a class="header" href="#using---force">Using <code>--force</code></a></h2>
<p>To overwrite and reload data, use the <code>--force</code> option with the <code>docker exec</code>
command.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia \
    --force
</code></pre>
<p>Using <code>--force</code> outputs the following message during import when prior data exists.</p>
<pre><code>2023-05-14 15:09:12,457:WARNING:pgosm-flex:import_mode:Using --force, kiss existing data goodbye
</code></pre>
<h3 id="only-overwrites-tables-in-new---layerset"><a class="header" href="#only-overwrites-tables-in-new---layerset">Only overwrites tables in new <code>--layerset</code></a></h3>
<p>Using <code>--force</code> can cause unexpected mismatches between tables when different
<a href="layersets.html">layersets</a> are used.  This section illustrates this problem.</p>
<p>First run <code>docker exec</code> as shown in the <a href="./quick-start.html">quick start</a> guide.
This loads the District of Columbia subregion with the default layerset.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=district-of-columbia
</code></pre>
<p>Now run again with <code>--force</code> and <code>--layerset=minimal</code>.  A different region
(Rhode Island) is also used to help illustrate the problem.</p>
<pre><code class="language-bash">docker exec -it \
    pgosm python3 docker/pgosm_flex.py \
    --ram=8 \
    --region=north-america/us \
    --subregion=rhode-island \
    --force \
    --layerset=minimal
</code></pre>
<p>The following image shows that while the <code>osm.place_polgyon</code> data is correctly loaded
with the Rhode Island region's data, the <code>osm.building_point</code> retained the
data from Washington D.C.  This happens because <code>--force</code> only allows PgOSM Flex
to overwrite data as defined by the <code>--layerset</code> option.  If tables were created
by layers not used in the latest <code>--layerset</code>, they will be left in the database
as-is.</p>
<p><img src="./pgosm-flex-with-force-inconsistent-region.jpg" alt="Image showing a map of the northeast region of the U.S. containing Washington D.C. to Rhode Island.  In the upper right corner (NE on the map) the Rhode Island region shows the place polygon data loaded as expected.  The lower left corner (SW on the map) shows the building data, not included in the minimal layerset, is still displaying in the D.C. area." /></p>
<p>While this problem is most apparent when using different regions, it can also be
a problem with the same region if a user querying the data assumes all tables
were updated at the same time.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="projects-using-pgosm-flex"><a class="header" href="#projects-using-pgosm-flex">Projects using PgOSM Flex</a></h1>
<p>Do you have a project using PgOSM Flex?  Submit a PR with details!</p>
<ul>
<li>geoshiny - create highly customized maps - <a href="https://github.com/jacopofar/geoshiny">github repo</a></li>
<li>eBook - Mastering PostGIS and OpenStreetMap by Ryan Lambert - <a href="https://postgis-osm.com/">website</a></li>
<li>Geo Faker - <a href="https://geofaker.com/">documentation</a> - <a href="https://github.com/rustprooflabs/geofaker">github</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pgosm-flex-docker"><a class="header" href="#pgosm-flex-docker">PgOSM Flex Docker</a></h1>
<p>This page outlines how and when images are built and pushed to Docker Hub.</p>
<h2 id="docker-image-background"><a class="header" href="#docker-image-background">Docker image background</a></h2>
<p>The PgOSM Flex Docker image uses
<a href="https://hub.docker.com/_/postgres/">main Postgres image</a>
via the <a href="https://hub.docker.com/r/postgis/postgis">main PostGIS image</a>
as starting point.
Those repositories have detailed instructions on using and customizing the core
Postgres functionality.</p>
<h2 id="images-on-docker-hub"><a class="header" href="#images-on-docker-hub">Images on Docker Hub</a></h2>
<p>There are three main types of images pushed to Docker Hub.</p>
<ul>
<li><code>latest</code></li>
<li><code>x.x.x</code></li>
<li><code>dev</code></li>
</ul>
<p>Which branch is best for you depends on how you use the data from PgOSM Flex.</p>
<h3 id="when-to-use-tagged-xxx-release"><a class="header" href="#when-to-use-tagged-xxx-release">When to use tagged (<code>x.x.x</code>) release</a></h3>
<p>Tagged releases are the most stable option and are recommended if you are
using <code>--replication</code> or <code>--update</code> mode.
Tagged releases are built with the latest versions of all key software, e.g. Postgres,
PostGIS and osm2pgsql, and their dependencies.  These tagged images (e.g. <code>0.6.2</code>)
are typically built at the time the tag is added to GitHub, and are (typically)
not rebuilt.</p>
<p>PgOSM Flex is still evolving on a regular basis. This means new tagged releases
are coming out as activity happens in the project.</p>
<h3 id="when-to-use-latest"><a class="header" href="#when-to-use-latest">When to use <code>latest</code></a></h3>
<p>If you run PgOSM Flex without <code>--replication</code> or <code>--update</code> mode this image is
generally stable and includes the latest features.</p>
<p>The <code>latest</code> Docker image could include changes that
require manual changes in Postgres.  Those changes are documented in the release notes,
for example, see "Notes for <code>--append</code> users" in <a href="https://github.com/rustprooflabs/pgosm-flex/releases/tag/0.6.1">0.6.1 release notes</a>.</p>
<h3 id="when-to-use-dev"><a class="header" href="#when-to-use-dev">When to use <code>dev</code></a></h3>
<p>The <code>dev</code> image exists when there's something worth testing.  Typically the <code>dev</code>
image is deleted from Docker Hub as functionality is worked into the <code>latest</code> image.</p>
<h2 id="building-the-image"><a class="header" href="#building-the-image">Building the image</a></h2>
<p>Build latest.  Occasionally run with <code>--no-cache</code> to force some software updates.</p>
<pre><code class="language-bash">docker build -t rustprooflabs/pgosm-flex .
</code></pre>
<p>Tag with version.</p>
<pre><code class="language-bash">docker build -t rustprooflabs/pgosm-flex:0.10.0 .
</code></pre>
<p>Push to Docker Hub.</p>
<pre><code class="language-bash">docker push rustprooflabs/pgosm-flex:latest
docker push rustprooflabs/pgosm-flex:0.10.0
</code></pre>
<h3 id="ensure-updates"><a class="header" href="#ensure-updates">Ensure updates</a></h3>
<p>To be certain the latest images are being used and latest
software is installed, pull the latest PostGIS image and build
the PgOSM Flex image using <code>--no-cache</code>.</p>
<pre><code class="language-bash">docker pull postgis/postgis:16-3.4
docker build --no-cache -t rustprooflabs/pgosm-flex:dev .
</code></pre>
<h2 id="building-pgosm-flex-from-an-osm2pgsql-feature-branch"><a class="header" href="#building-pgosm-flex-from-an-osm2pgsql-feature-branch">Building PgOSM Flex from an <code>osm2pgsql</code> feature branch</a></h2>
<p>There are times it is helpful to build the PgOSM Flex Docker image with a
specific feature branch. To do this, change the <code>OSM2PGSQL_BRANCH</code>
and/or <code>OSM2PGSQL_REPO</code> arguments as necessary at the beginning of the Dockerfile.
The production setup looks like the following example.</p>
<pre><code class="language-Dockerfile">ARG OSM2PGSQL_BRANCH=master
ARG OSM2PGSQL_REPO=https://github.com/osm2pgsql-dev/osm2pgsql.git
</code></pre>
<p>To test the feature branch associated with
<a href="https://github.com/osm2pgsql-dev/osm2pgsql/pull/2212">osm2pgsql #2212</a>
the updated version was set like the following example.
This changes the <code>OSM2PGSQL_BRANCH</code> to <code>check-date-on-replication-init</code>
and changes the username in the <code>OSM2PGSQL_REPO</code> to <code>lonvia</code>.</p>
<pre><code class="language-Dockerfile">ARG OSM2PGSQL_BRANCH=check-date-on-replication-init
ARG OSM2PGSQL_REPO=https://github.com/lonvia/osm2pgsql.git
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing-pgosm-flex"><a class="header" href="#testing-pgosm-flex">Testing PgOSM Flex</a></h1>
<p>The <code>Makefile</code> at the root of this project tests many core aspects of
PgOSM Flex's functionality.  It builds the Docker image, tests a few usage
scenarios (including <code>--input-file</code>) and runs both Python unit tests
and Data Import tests.  The data import tests verify row counts by
<code>osm_type</code> and <code>osm_subtype</code> of many tables.</p>
<h2 id="run-all-tests"><a class="header" href="#run-all-tests">Run all tests</a></h2>
<p>To run all tests run <code>make</code> from the project's root directory.</p>
<pre><code class="language-bash">make
</code></pre>
<p>A simplified usage for quicker testing during development.</p>
<pre><code class="language-bash">make docker-exec-default unit-tests
</code></pre>
<h2 id="data-tests"><a class="header" href="#data-tests">Data Tests</a></h2>
<p>Under <code>pgosm-flex/tests</code>.  The <code>run-output-tests.sh</code> script is ran by
running <code>make</code>.  The script loops over the <code>.sql</code> scripts under
<code>pgosm-flex/tests/sql/</code>, runs the queries via <code>psql</code> using
<code>--no-psqlrc -tA</code> and compares the output from the query against the
expected output saved under <code>pgosm-flex/tests/expected</code>.
Running <code>make docker-exec-default unit-tests</code> should finish with this line
reporting data tests completed successfully.</p>
<pre><code class="language-bash">Data output tests completed successfully.
</code></pre>
<p>If something in the Lua styles or SQL post-processing changes, the intention is
they will be reported by these tests.   Note the second line of this section
reports the <code>docker exec</code> command to run in order to see the changes to the
data tests.</p>
<pre><code class="language-bash">FAILED TEST: sql/shop_polygon_osm_type_subtype_count.sql - See tmp/shop_polygon_osm_type_subtype_count.diff
  docker exec -it pgosm /bin/bash -c "cat /app/tests/tmp/shop_polygon_osm_type_subtype_count.diff " 
One or more data output tests failed.
</code></pre>
<p>The output from the <code>docker exec</code> command looks like the following.
Note the <code>-</code> and <code>+</code> lines showing the count of records with
<code>osm_type='shop'</code> and <code>osm_subtype='chemist'</code> changed from 1 to 2.</p>
<pre><code class="language-bash">diff --git a/expected/shop_polygon_osm_type_subtype_count.out b/tmp/shop_polygon_osm_type_subtype_count.out
index 75c16c3..2385d8d 100644
--- a/expected/shop_polygon_osm_type_subtype_count.out
+++ b/tmp/shop_polygon_osm_type_subtype_count.out
@@ -12,7 +12,7 @@ shop|books|1
 shop|car|4
 shop|car_parts|3
 shop|car_repair|7
-shop|chemist|1
+shop|chemist|2
 shop|clothes|8
 shop|convenience|35
 shop|copyshop|1
</code></pre>
<h3 id="add--update-data-tests"><a class="header" href="#add--update-data-tests">Add / Update Data Tests</a></h3>
<p>This section provides guidance to adding/updating data tests for PgOSM Flex.
The SQL file to run is under <code>tests/sql/*.sql</code>, the expected results are saved
under <code>tests/expected/*.out</code>.</p>
<h4 id="load-test-data"><a class="header" href="#load-test-data">Load Test Data</a></h4>
<p>Load <code>data/district-of-columbia-2021-01-13.osm.pbf</code> with <code>run-all</code>
before running these tests.</p>
<blockquote>
<p>PBF sourced <a href="https://download.geofabrik.de/">from Geofabrik's download service</a> on January 13, 2021.</p>
</blockquote>
<h4 id="craft-test-query"><a class="header" href="#craft-test-query">Craft Test Query</a></h4>
<p>Connect to the PgOSM Flex database with <code>data/district-of-columbia-2021-01-13.osm.pbf</code>
loaded.  Write the query that provide results to test for.</p>
<p>Important:  Results must be ordered using <code>COLLATE "C"</code> to ensure consistent
ordering across systems.  For example it should be written like this:</p>
<pre><code class="language-sql">SELECT osm_type COLLATE "C", COUNT(*)
    FROM osm.amenity_point
    GROUP BY osm_type COLLATE "C"
    ORDER BY osm_type COLLATE "C"
;
</code></pre>
<p>Not like this:</p>
<pre><code class="language-sql">SELECT osm_type, COUNT(*)
    FROM osm.amenity_point
    GROUP BY osm_type
    ORDER BY osm_type
;
</code></pre>
<h4 id="create-expected-output"><a class="header" href="#create-expected-output">Create Expected Output</a></h4>
<p>To create new tests, or to update existing tests use <code>psql --no-psqlrc -tA &lt;details&gt;</code>.
Example for amenity count of <code>osm_type</code>.</p>
<p>Assuming <a href="quick-start.html">Quick Start</a> instructions, set the env var for the Postgres
connection first.</p>
<pre><code class="language-bash">export PGOSM_CONN=postgresql://postgres:mysecretpassword@localhost:5433/pgosm
</code></pre>
<p>Run the query, save the output.</p>
<pre><code class="language-bash">psql --no-psqlrc -tA  \
    -d $PGOSM_CONN \
     -f sql/amenity_osm_type_count.sql \
     &gt; expected/amenity_osm_type_count.out
</code></pre>
<h4 id="validate-new-tests"><a class="header" href="#validate-new-tests">Validate New Tests</a></h4>
<p>Ensure the data tests work and are reported if values change via <code>make</code>.
The best way to ensure the test is working is manually change one value in the
generated <code>.out</code> file which should cause the following error message.
Setting the <code>.out</code> data back to right should return the message back to successful.</p>
<pre><code class="language-bash">FAILED TEST: sql/shop_polygon_osm_type_subtype_count.sql - See tmp/shop_polygon_osm_type_subtype_count.diff
  docker exec -it pgosm /bin/bash -c "cat /app/tests/tmp/shop_polygon_osm_type_subtype_count.diff " 
One or more data output tests failed.
</code></pre>
<hr />
<h3 id="create-pbfs-for-areas-w-failures"><a class="header" href="#create-pbfs-for-areas-w-failures">Create PBFs for areas w/ Failures</a></h3>
<p>Identify a feature related to the issue and load small region around
into JOSM (as if making an edit).</p>
<p>Use JOSM's "Save As..." to save the <code>&lt;region-failure-name&gt;.osm</code> file.
Use <code>osmium-tool</code> (https://osmcode.org/osmium-tool/manual.html)
to convert to <code>.pbf</code> format.</p>
<pre><code class="language-bash">osmium cat  &lt;region-failure-name&gt;.osm -o &lt;region-failure-name&gt;.osm.pbf
mv &lt;region-failure-name&gt;.osm.pbf ~/git/pgosm-flex/tests/data/extra-regions/
</code></pre>
<h3 id="test-for-import-failures"><a class="header" href="#test-for-import-failures">Test for import failures</a></h3>
<p>Test for specific regions that have had failures due to unusual
tags and/or bugs in PgOSM-Flex.</p>
<p>Run extra region load tests.</p>
<pre><code class="language-bash">export PGOSM_CONN=pgosm_tests
export PGOSM_CONN_PG=postgres
./run-extra-loads.sh
</code></pre>
<blockquote>
<p>FIXME: At this time the <code>run-extra-loads.sh</code> script is not ran automatically.  There are not any usage notes covering those random side tests.</p>
</blockquote>
<h2 id="python-unit-tests"><a class="header" href="#python-unit-tests">Python unit tests</a></h2>
<p>The Python unit tests are under <code>pgosm-flex/docker/tests/</code>.  These tests use
Python's <code>unittest</code> module.  The <code>make</code> process runs these using
<code>coverage run ...</code> and <code>coverage report ...</code>.
See the <a href="https://github.com/rustprooflabs/pgosm-flex/blob/main/Makefile">Makefile</a>
for exact implementation.</p>
<p>These unit tests cover specific logic and functionality to how PgOSM Flex's Python
program runs.</p>
<hr />
<h2 id="what-is-not-tested"><a class="header" href="#what-is-not-tested">What is not tested</a></h2>
<p>Functionality of <code>osm2pgsql-replication</code> to actually update data.  Challenge
is that to test this it requires having a recent <code>.osm.pbf</code> file for the initial
import. Attempting to use the test D.C. file used for all other testing
(from January 13, 2021), the initial import works, however a subsequent
refresh fails.</p>
<pre><code class="language-bash">2023-01-29 08:11:35,553:INFO:pgosm-flex:helpers:2023-01-29 08:11:35 [INFO]: Using replication service 'http://download.geofabrik.de/north-america/us/district-of-columbia-updates'. Current sequence 2856 (2021-01-13 14:42:03-07:00).
2023-01-29 08:11:36,866:INFO:pgosm-flex:helpers:Traceback (most recent call last):
2023-01-29 08:11:36,866:INFO:pgosm-flex:helpers:File "/usr/local/bin/osm2pgsql-replication", line 556, in &lt;module&gt;
2023-01-29 08:11:36,866:INFO:pgosm-flex:helpers:sys.exit(main())
2023-01-29 08:11:36,866:INFO:pgosm-flex:helpers:File "/usr/local/bin/osm2pgsql-replication", line 550, in main
2023-01-29 08:11:36,867:INFO:pgosm-flex:helpers:return args.handler(conn, args)
2023-01-29 08:11:36,867:INFO:pgosm-flex:helpers:File "/usr/local/bin/osm2pgsql-replication", line 402, in update
2023-01-29 08:11:36,867:INFO:pgosm-flex:helpers:endseq = repl.apply_diffs(outhandler, seq + 1,
2023-01-29 08:11:36,867:INFO:pgosm-flex:helpers:File "/usr/local/lib/python3.9/dist-packages/osmium/replication/server.py", line 177, in apply_diffs
2023-01-29 08:11:36,868:INFO:pgosm-flex:helpers:diffs = self.collect_diffs(start_id, max_size)
2023-01-29 08:11:36,868:INFO:pgosm-flex:helpers:File "/usr/local/lib/python3.9/dist-packages/osmium/replication/server.py", line 143, in collect_diffs
2023-01-29 08:11:36,868:INFO:pgosm-flex:helpers:left_size -= rd.add_buffer(diffdata, self.diff_type)
2023-01-29 08:11:36,868:INFO:pgosm-flex:helpers:RuntimeError: gzip error: inflate failed: incorrect header check
2023-01-29 08:11:36,890:WARNING:pgosm-flex:pgosm_flex:Failure. Return code: 1
2023-01-29 08:11:36,890:INFO:pgosm-flex:pgosm_flex:Skipping pg_dump
2023-01-29 08:11:36,890:WARNING:pgosm-flex:pgosm_flex:PgOSM Flex completed with errors. Details in output
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developing-qgis-styles"><a class="header" href="#developing-qgis-styles">Developing QGIS Styles</a></h1>
<p>This page explains how to maintain QGIS layer styles.</p>
<h2 id="addupdate-existing-records"><a class="header" href="#addupdate-existing-records">Add/Update existing records</a></h2>
<p>The QGIS table does not include <code>UNIQUE</code> constraints, so using Postgres' <code>UPSERT</code> is
not available by default.</p>
<p>Add new records from staging, based on object names.</p>
<pre><code class="language-sql">INSERT INTO public.layer_styles
    (f_table_catalog, f_table_schema, f_table_name,
     f_geometry_column, stylename, styleqml, stylesld,
     useasdefault, description, "owner", ui, update_time)
SELECT new.f_table_catalog, new.f_table_schema, new.f_table_name,
     new.f_geometry_column, new.stylename, new.styleqml, new.stylesld,
     new.useasdefault, new.description, new."owner", new.ui, new.update_time
    FROM public.layer_styles_staging new
    LEFT JOIN public.layer_styles ls
        ON new.f_table_catalog = ls.f_table_catalog 
            AND new.f_table_schema = ls.f_table_schema
            AND new.f_table_name = ls.f_table_name
            AND new.stylename = ls.stylename
    WHERE ls.id IS NULL
;
</code></pre>
<p>To update existing styles.</p>
<pre><code class="language-sql">UPDATE public.layer_styles ls
    SET f_geometry_column = new.f_geometry_column,
        styleqml = new.styleqml,
        stylesld = new.stylesld,
        useasdefault = new.useasdefault,
        description = new.description,
        "owner" = new."owner",
        ui = new.ui,
        update_time = new.update_time
    FROM public.layer_styles_staging new
    WHERE new.f_table_catalog = ls.f_table_catalog 
        AND new.f_table_schema = ls.f_table_schema
        AND new.f_table_name = ls.f_table_name
        AND new.stylename = ls.stylename
;
</code></pre>
<p>Cleanup the staging table.</p>
<pre><code class="language-sql">DELETE FROM public.layer_styles_staging;
</code></pre>
<h2 id="updating-style-sql"><a class="header" href="#updating-style-sql">Updating Style .sql</a></h2>
<p>To update (or create new) the .sql file with styles.</p>
<p>Load into <code>_staging</code> table so restoring the data puts it back in the same place.
Optionally add a <code>WHERE</code> clause to only export certain styles.</p>
<p>You may want to update the <code>owner</code> field.</p>
<pre><code class="language-sql">INSERT INTO public.layer_styles_staging
SELECT * FROM public.layer_styles;

UPDATE public.layer_styles_staging
    SET owner = 'rustprooflabs'
    WHERE owner != 'rustprooflabs'
;
</code></pre>
<pre><code class="language-bash">pg_dump --no-owner --no-privileges --data-only --table=public.layer_styles_staging \
    -d pgosm \
    -f layer_styles.sql
</code></pre>
<p>Cleanup the staging table.</p>
<pre><code class="language-sql">DELETE FROM public.layer_styles_staging;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="troubleshoot-errors-in-osm2pgsql-processing"><a class="header" href="#troubleshoot-errors-in-osm2pgsql-processing">Troubleshoot errors in osm2pgsql processing</a></h1>
<p>This section contains rough notes about how to troubleshoot errors in PgOSM Flex.</p>
<h2 id="reduce---ram"><a class="header" href="#reduce---ram">Reduce <code>--ram</code></a></h2>
<p>If you encounter an unusual failure during the <code>osm2pgsql</code> step of PgOSM Flex,
try reducing the <code>--ram</code> value.  Choosing a <code>--ram</code> option too high can cause
the process to fail with a variety of unexpected errors.  If that isn't the problem,
continue reading.</p>
<h2 id="docker-logs"><a class="header" href="#docker-logs">Docker logs</a></h2>
<p>Output such as this.</p>
<pre><code class="language-bash">2023-02-26 22:14:31,760:INFO:pgosm-flex:helpers:Processing: Node(10k 10.0k/s) Way(0k 0.00k/s) Relation(0Processing: Node(84760k 277.9k/s) Way(0k 0.00k/s) Relation(0 0.0/s)
2023-02-26 22:14:31,774:ERROR:pgosm-flex:pgosm_flex:Failed to run osm2pgsql. Return code: -9
Failed to run osm2pgsql. Return code: -9 - Check the log output for details
</code></pre>
<p>Checking logs from Docker might shed light on issue.</p>
<pre><code class="language-bash">docker logs pgosm
</code></pre>
<pre><code>2023-02-26 22:14:31.777 UTC [114] LOG:  incomplete message from client
2023-02-26 22:14:31.777 UTC [114] CONTEXT:  COPY tags, line 1
2023-02-26 22:14:31.777 UTC [114] STATEMENT:  COPY "osm"."tags" ("geom_type","osm_id","tags") FROM STDIN
2023-02-26 22:14:31.807 UTC [114] ERROR:  unexpected EOF on client connection with an open transaction
2023-02-26 22:14:31.807 UTC [114] CONTEXT:  COPY tags, line 1
2023-02-26 22:14:31.807 UTC [114] STATEMENT:  COPY "osm"."tags" ("geom_type","osm_id","tags") FROM STDIN
2023-02-26 22:14:31.812 UTC [114] FATAL:  terminating connection because protocol synchronization was lost
2023-02-26 22:14:31.822 UTC [114] LOG:  could not send data to client: Broken pipe
</code></pre>
<h2 id="troubleshoot-within-docker"><a class="header" href="#troubleshoot-within-docker">Troubleshoot within Docker</a></h2>
<p>Enter the docker container into <code>/bin/bash</code>.</p>
<pre><code class="language-bash">docker exec -it pgosm /bin/bash
</code></pre>
<p>Set environment variables required for PgOSM Flex's operation.</p>
<pre><code class="language-bash">export PGOSM_CONN=postgresql://postgres:mysecretpassword@localhost:5432/pgosm?application_name=pgosm-flex
export PGOSM_REPLICATION=False
export PGOSM_IMPORT_UUID=this-is-not-a-real-uuid
export PGOSM_LAYERSET=minimal
</code></pre>
<p>Run <code>osm2pgsql</code> manually.  Start with a simple operation shown below,
consider adding adding <code>-v</code> and/or <code>--log-sql-data</code> to the <code>osm2pgsql</code> command
to dig deeper.</p>
<pre><code class="language-bash">osm2pgsql -d $PGOSM_CONN \
    --create --output=flex --style=./run.lua \
    /app/output/district-of-columbia-latest.osm.pbf
</code></pre>
<h2 id="configure-more-things"><a class="header" href="#configure-more-things">Configure more things</a></h2>
<pre><code class="language-bash">docker run --name pgosm -d --rm \
    -v ~/pgosm-data:/app/output \
    -v /etc/localtime:/etc/localtime:ro \
    -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
    -p 5433:5432 -d rustprooflabs/pgosm-flex \
    -c shared_buffers=1GB \
    -c work_mem=50MB \
    -c maintenance_work_mem=10GB \
    -c autovacuum_work_mem=2GB \
    -c checkpoint_timeout=300min \
    -c max_wal_senders=0 -c wal_level=minimal \
    -c max_wal_size=10GB \
    -c checkpoint_completion_target=0.9 \
    -c random_page_cost=1.0 \
    -c full_page_writes=off \
    -c fsync=off \
    -c log_statement=all \
    -c log_duration=on
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
